<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxi - Domiciliario</title>
    
    <!-- üîí META TAGS ANTI-CACH√â -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .login-container {
            padding: 30px 20px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            font-size: 60px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input.error {
            border-color: #e74c3c;
        }

        .form-hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .content {
            padding: 20px;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            text-align: center;
        }

        .status-item .label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .status-item .value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-indicator.active {
            background: #27ae60;
            box-shadow: 0 0 10px #27ae60;
        }

        .status-indicator.inactive {
            background: #e74c3c;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .order-card {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .order-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .order-id {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .order-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .order-status.pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .order-status.asignado {
            background: #d1ecf1;
            color: #0c5460;
        }

        .order-status.en_camino {
            background: #cce5ff;
            color: #004085;
        }

        .order-detail {
            margin-bottom: 15px;
        }

        .order-detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .order-detail-row:last-child {
            border-bottom: none;
        }

        .order-detail-label {
            font-size: 13px;
            color: #7f8c8d;
            width: 100px;
            flex-shrink: 0;
        }

        .order-detail-value {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 600;
            flex: 1;
        }

        .timer-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .timer-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .timer-value {
            font-size: 48px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .empty-state-subtext {
            font-size: 14px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-buttons.single {
            grid-template-columns: 1fr;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert {
            animation: slideIn 0.3s ease-out;
        }

        .new-order-badge {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            z-index: 1000;
            animation: pulse 1s infinite;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 12px;
        }

        .login-help {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 13px;
            color: #495057;
        }

        .login-help strong {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .login-help ul {
            margin: 0;
            padding-left: 20px;
        }

        .login-help li {
            margin: 5px 0;
        }

        .location-control {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .location-control.active {
            border-color: #27ae60;
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.05) 0%, rgba(39, 174, 96, 0.1) 100%);
        }

        .location-control.inactive {
            border-color: #e74c3c;
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.05) 0%, rgba(231, 76, 60, 0.1) 100%);
        }

        .location-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .location-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-message {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .location-message.success {
            color: #27ae60;
        }

        .location-message.error {
            color: #e74c3c;
        }

        .btn-location {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-location.activate {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-location.activate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-location.deactivate {
            background: #95a5a6;
            color: white;
        }

        .btn-location:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .location-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 8px;
            font-size: 13px;
            color: #27ae60;
            margin-top: 10px;
        }

        .location-warning {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            font-size: 13px;
            color: #e74c3c;
            margin-bottom: 15px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="login-screen">
            <div class="header">
                <h1>üöÄ Fluxi</h1>
                <div class="subtitle">App para Domiciliarios</div>
            </div>
            <div class="login-container">
                <div class="logo">üèçÔ∏è</div>
                <div id="login-alert"></div>
                <form id="login-form">
                    <div class="form-group">
                        <label>N√∫mero de Tel√©fono</label>
                        <input type="tel" id="login-phone" required placeholder="+573001234567" value="+57">
                        <div class="form-hint">Formato: +57 seguido de 10 d√≠gitos (Ej: +573001234567)</div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="login-btn">Iniciar Sesi√≥n</button>
                </form>

                <div class="login-help">
                    <strong>üí° ¬øNo puedes ingresar?</strong>
                    <ul>
                        <li>Aseg√∫rate de usar el n√∫mero registrado exactamente como fue creado</li>
                        <li>Debe incluir +57 seguido de 10 d√≠gitos</li>
                        <li>No uses espacios ni guiones</li>
                        <li>Ejemplo correcto: +573001234567</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="app-screen" class="hidden">
            <div class="header">
                <button class="logout-btn" id="logout-btn">Salir</button>
                <h1>üèçÔ∏è <span id="delivery-name">Domiciliario</span></h1>
                <div class="subtitle">
                    <span class="status-indicator" id="location-indicator"></span>
                    <span id="location-status">Ubicaci√≥n desactivada</span>
                </div>
            </div>

            <div class="content">
                <!-- Location Control -->
                <div id="location-control" class="location-control inactive">
                    <div class="location-header">
                        <div class="location-title">
                            <span id="location-icon">üìç</span>
                            <span>Control de Ubicaci√≥n</span>
                        </div>
                        <span class="status-indicator inactive" id="location-indicator-main"></span>
                    </div>
                    
                    <div id="location-warning" class="location-warning">
                        <span>‚ö†Ô∏è</span>
                        <div>
                            <strong>Ubicaci√≥n desactivada</strong><br>
                            Debes activar tu ubicaci√≥n para poder aceptar pedidos. El cliente necesita ver d√≥nde est√°s en tiempo real.
                        </div>
                    </div>
                    
                    <div id="location-message" class="location-message">
                        Toca el bot√≥n para compartir tu ubicaci√≥n
                    </div>
                    
                    <button id="btn-toggle-location" class="btn-location activate" onclick="window.toggleLocation()">
                        <span id="location-btn-icon">üìç</span>
                        <span id="location-btn-text">Activar Ubicaci√≥n</span>
                    </button>
                    
                    <div id="location-info" class="location-info hidden">
                        <span>‚úÖ</span>
                        <div>
                            <strong>Ubicaci√≥n compartida</strong><br>
                            <span id="location-status-detail">Actualizado: --:--</span>
                        </div>
                    </div>
                </div>

                <div class="status-bar">
                    <div class="status-item">
                        <div class="label">Pedidos Hoy</div>
                        <div class="value" id="orders-today">0</div>
                    </div>
                    <div class="status-item">
                        <div class="label">Completados</div>
                        <div class="value" id="orders-completed">0</div>
                    </div>
                    <div class="status-item">
                        <div class="label">En Curso</div>
                        <div class="value" id="orders-active">0</div>
                    </div>
                </div>

                <div id="alert-container"></div>

                <!-- Cash Balance Section -->
                <div id="cash-balance-section" style="margin: 20px 0;">
                    <h2 style="margin-bottom: 5px; color: #2c3e50;">üí∞ Mi Cuadre de Caja</h2>
                    <p id="balance-period-info" style="font-size: 12px; color: #7f8c8d; margin-bottom: 15px;">Desde las 8:00 AM de hoy</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <!-- Valor Arranque -->
                        <div style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
                                    color: white;
                                    padding: 15px;
                                    border-radius: 10px;
                                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üíµ Valor Arranque</div>
                            <div id="balance-arranque" style="font-size: 20px; font-weight: bold;">$0</div>
                        </div>

                        <!-- Efectivo Recaudado -->
                        <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
                                    color: white;
                                    padding: 15px;
                                    border-radius: 10px;
                                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 5px;">üíµ Efectivo Recaudado</div>
                            <div id="balance-efectivo" style="font-size: 20px; font-weight: bold;">$0</div>
                        </div>
                    </div>

                    <!-- Total Efectivo -->
                    <div style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
                                color: white;
                                padding: 15px;
                                border-radius: 10px;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                                margin-bottom: 15px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">üí∞ Total Efectivo (Arranque + Recaudado)</div>
                        <div id="balance-total-efectivo" style="font-size: 24px; font-weight: bold;">$0</div>
                    </div>

                    <!-- Tarjetas por Dat√°fono -->
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                                color: white;
                                padding: 15px;
                                border-radius: 10px;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                                margin-bottom: 15px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">üí≥ Pagos con Dat√°fono</div>
                        <div id="balance-datafono-info" style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">Dat√°fono: --</div>
                        <div id="balance-tarjetas" style="font-size: 22px; font-weight: bold;">$0</div>
                    </div>

                    <!-- Total General -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 18px;
                                border-radius: 10px;
                                box-shadow: 0 3px 8px rgba(0,0,0,0.15);">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">üíé Total General</div>
                        <div id="balance-total-general" style="font-size: 28px; font-weight: bold;">$0</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">Efectivo + Tarjetas</div>
                    </div>
                </div>

                <!-- Active Order Section -->
                <div id="active-order-container" class="hidden">
                    <h2 style="margin-bottom: 15px; color: #2c3e50;">üì¶ Pedido Activo</h2>
                    
                    <div class="timer-display">
                        <div class="timer-label">‚è±Ô∏è Tiempo Transcurrido</div>
                        <div class="timer-value" id="timer-display">00:00:00</div>
                    </div>

                    <div id="active-order-card"></div>
                </div>

                <!-- Available Orders Section -->
                <div id="available-orders-container">
                    <h2 style="margin-bottom: 15px; color: #2c3e50;">üìã Pedidos Disponibles</h2>
                    <div id="orders-list"></div>
                </div>
            </div>

            <div class="footer">
                Fluxi ¬© 2025 - Sistema de Domicilios
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const SUPABASE_URL = 'https://lbifbexhmvbanvrjfglp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxiaWZiZXhobXZiYW52cmpmZ2xwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5Mjg5MDQsImV4cCI6MjA3NjUwNDkwNH0.ZXjCv4DkNobkn3IDK9wYBjjOV55Bf_UwcSxhkt6YqGo';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // üîñ SISTEMA DE VERSIONES Y CONTROL DE CACH√â
        const APP_VERSION = '2.2.0'; // ACTUALIZADO: 24-Oct-2024 - Fix tracking + Background support
        const VERSION_KEY = 'fluxi_delivery_version';
        
        // Verificar versi√≥n y detectar cach√©
        (function checkVersion() {
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #667eea; font-weight: bold;');
            console.log('%cüîñ Fluxi Domiciliario - Versi√≥n ' + APP_VERSION, 'color: #667eea; font-weight: bold; font-size: 14px;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #667eea; font-weight: bold;');
            
            const savedVersion = localStorage.getItem(VERSION_KEY);
            
            if (savedVersion !== APP_VERSION) {
                if (savedVersion) {
                    console.log('%cüÜï NUEVA VERSI√ìN DETECTADA', 'color: #27ae60; font-weight: bold; font-size: 13px;');
                    console.log('%c   Versi√≥n anterior:', 'color: #95a5a6;', savedVersion);
                    console.log('%c   Versi√≥n actual:', 'color: #27ae60;', APP_VERSION);
                    console.log('%c   ‚úÖ Novedades:', 'color: #3498db;');
                    console.log('%c      ‚Ä¢ Ubicaci√≥n se actualiza al completar entregas', 'color: #3498db;');
                    console.log('%c      ‚Ä¢ Ubicaci√≥n NO se activa autom√°ticamente (solo con bot√≥n)', 'color: #3498db;');
                    console.log('%c      ‚Ä¢ Tracking funciona en segundo plano', 'color: #3498db;');
                    console.log('%c      ‚Ä¢ Soporte para Wake Lock (mantiene app activa)', 'color: #3498db;');
                    
                    // Mostrar notificaci√≥n al usuario
                    setTimeout(() => {
                        showAlert('üÜï Nueva versi√≥n ' + APP_VERSION + ' instalada. Ahora soporta tracking en segundo plano y control manual de ubicaci√≥n.', 'success');
                    }, 2000);
                }
                
                // Guardar nueva versi√≥n
                localStorage.setItem(VERSION_KEY, APP_VERSION);
            } else {
                console.log('%c‚úÖ Versi√≥n actual:', 'color: #27ae60;', APP_VERSION);
            }
            
            console.log('%cüí° TIP: Si ves problemas, cierra y abre la app de nuevo', 'color: #f39c12; font-style: italic;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #667eea; font-weight: bold;');
        })();
        
        // Exponer versi√≥n globalmente
        window.FLUXI_VERSION = APP_VERSION;

        let currentDelivery = null;
        let activeOrder = null;
        let locationWatchId = null;
        let locationUpdateInterval = null;
        let timerInterval = null;
        let timerStartTime = null;
        let realtimeChannel = null;
        let isLocationActive = false; // Nueva variable para trackear estado de ubicaci√≥n
        let locationUpdateCount = 0; // NUEVO: Contador de actualizaciones de ubicaci√≥n
        
        // üîã VARIABLES PARA TRACKING EN SEGUNDO PLANO
        let wakeLock = null; // Para mantener la pantalla activa (opcional)
        let isAppInBackground = false; // Para detectar si la app est√° en background
        let backgroundUpdateCount = 0; // Contador de actualizaciones en background

        // üì± SISTEMA DE TRACKING EN SEGUNDO PLANO
        // Configurar listeners para detectar cuando la app va a background/foreground
        (function setupBackgroundTracking() {
            console.log('üîß Configurando sistema de tracking en segundo plano...');
            
            // Page Visibility API - detecta cuando la app est√° oculta/visible
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('üì¥ App movida a segundo plano');
                    isAppInBackground = true;
                    
                    if (isLocationActive) {
                        console.log('üìç Ubicaci√≥n activa - continuar√° actualiz√°ndose en segundo plano');
                        showAlert('üìç La app seguir√° actualizando tu ubicaci√≥n en segundo plano', 'info');
                    }
                } else {
                    console.log('üì≤ App restaurada al primer plano');
                    isAppInBackground = false;
                    
                    if (isLocationActive) {
                        console.log('‚úÖ Ubicaci√≥n activa - actualizaciones en segundo plano: ' + backgroundUpdateCount);
                    }
                }
            });
            
            // Lifecycle API - para apps en m√≥viles modernos
            if ('onfreeze' in document) {
                document.addEventListener('freeze', () => {
                    console.log('‚ùÑÔ∏è App congelada por el sistema');
                    if (isLocationActive) {
                        console.log('‚ö†Ô∏è La ubicaci√≥n puede dejar de actualizarse mientras est√© congelada');
                    }
                });
                
                document.addEventListener('resume', () => {
                    console.log('‚ñ∂Ô∏è App resumida');
                    if (isLocationActive) {
                        console.log('üîÑ Forzando actualizaci√≥n de ubicaci√≥n despu√©s de resumir...');
                        updateLocation().catch(err => console.error('Error al actualizar ubicaci√≥n:', err));
                    }
                });
            }
            
            // Detectar cuando el usuario vuelve a la pesta√±a (focus)
            window.addEventListener('focus', () => {
                if (isLocationActive && !document.hidden) {
                    console.log('üëÅÔ∏è Usuario volvi√≥ a la app');
                }
            });
            
            console.log('‚úÖ Sistema de tracking en segundo plano configurado');
        })();
        
        // üîã FUNCI√ìN PARA SOLICITAR WAKE LOCK (MANTENER PANTALLA ACTIVA)
        // Nota: Wake Lock ayuda pero NO es obligatorio. El tracking debe funcionar sin √©l.
        async function requestWakeLock() {
            // Solo intentar si la API est√° disponible
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('üîã Wake Lock activado - la pantalla permanecer√° activa');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('üîã Wake Lock liberado');
                        wakeLock = null;
                    });
                    
                    return true;
                } catch (err) {
                    console.warn('‚ö†Ô∏è No se pudo activar Wake Lock:', err.message);
                    console.log('‚ÑπÔ∏è El tracking seguir√° funcionando sin Wake Lock');
                    return false;
                }
            } else {
                console.log('‚ÑπÔ∏è Wake Lock API no disponible en este navegador');
                return false;
            }
        }
        
        // üîì FUNCI√ìN PARA LIBERAR WAKE LOCK
        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release()
                    .then(() => {
                        console.log('üîã Wake Lock liberado exitosamente');
                        wakeLock = null;
                    })
                    .catch(err => {
                        console.warn('‚ö†Ô∏è Error al liberar Wake Lock:', err);
                    });
            }
        }

        // Funci√≥n de debug para verificar estado del sistema de ubicaci√≥n
        window.checkLocationStatus = function() {
            console.log('üìä ========== ESTADO DEL SISTEMA DE UBICACI√ìN ==========');
            console.log('üì± Navegador:', navigator.userAgent.includes('Mobile') ? 'M√≥vil' : 'Desktop');
            console.log('üó∫Ô∏è Geolocalizaci√≥n disponible:', 'geolocation' in navigator ? '‚úÖ S√ç' : '‚ùå NO');
            console.log('üë§ Domiciliario actual:', currentDelivery ? currentDelivery.nombre : '‚ùå No hay sesi√≥n');
            console.log('üì¶ Pedido activo:', activeOrder ? `#${activeOrder.id.substring(0, 8)}` : '‚ùå Sin pedido');
            console.log('üìç Sistema de ubicaci√≥n:', isLocationActive ? '‚úÖ ACTIVO' : '‚ùå INACTIVO');
            console.log('‚è±Ô∏è Intervalo de actualizaci√≥n:', locationUpdateInterval ? `‚úÖ Corriendo (ID: ${locationUpdateInterval})` : '‚ùå No est√° corriendo');
            console.log('üëÄ WatchPosition:', locationWatchId ? `‚úÖ Activo (ID: ${locationWatchId})` : '‚ùå No est√° activo');
            console.log('üîã Wake Lock:', wakeLock ? '‚úÖ Activo' : '‚ùå Inactivo');
            console.log('üì¥ App en segundo plano:', isAppInBackground ? '‚úÖ S√ç' : '‚ùå NO');
            console.log('üìä Total de actualizaciones:', locationUpdateCount);
            console.log('üìä Actualizaciones en background:', backgroundUpdateCount);
            console.log('üïê Hora actual:', new Date().toLocaleTimeString('es-CO'));
            console.log('====================================================');
            
            if (!isLocationActive) {
                console.warn('‚ö†Ô∏è ADVERTENCIA: El sistema de ubicaci√≥n NO est√° activo.');
                console.log('üí° Soluci√≥n: Presiona el bot√≥n "Activar Ubicaci√≥n" en la app.');
            } else if (!locationUpdateInterval && !locationWatchId) {
                console.error('‚ùå ERROR: El sistema dice estar activo pero no hay intervalo ni watchPosition corriendo.');
                console.log('üí° Soluci√≥n: Desactiva y vuelve a activar la ubicaci√≥n.');
            } else {
                console.log('‚úÖ El sistema de ubicaci√≥n est√° funcionando correctamente.');
                if (isAppInBackground) {
                    console.log('üì¥ La app est√° en segundo plano - las actualizaciones continuar√°n autom√°ticamente');
                }
            }
            
            return {
                activo: isLocationActive,
                intervalo: !!locationUpdateInterval,
                watchPosition: !!locationWatchId,
                wakeLock: !!wakeLock,
                enBackground: isAppInBackground,
                actualizaciones: locationUpdateCount,
                actualizacionesBackground: backgroundUpdateCount
            };
        };
        
        // Exponer variables globalmente para debug
        window.debugLocationVars = {
            get isActive() { return isLocationActive; },
            get intervalId() { return locationUpdateInterval; },
            get watchId() { return locationWatchId; },
            get updateCount() { return locationUpdateCount; },
            get currentDelivery() { return currentDelivery; }
        };

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container') || document.getElementById('login-alert');
            const alertClass = `alert-${type}`;
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function validatePhone(phone) {
            // Eliminar espacios en blanco
            phone = phone.trim();
            
            // Verificar que empiece con +57
            if (!phone.startsWith('+57')) {
                return { valid: false, error: 'El n√∫mero debe comenzar con +57' };
            }
            
            // Verificar que tenga exactamente 13 caracteres (+57 + 10 d√≠gitos)
            if (phone.length !== 13) {
                return { valid: false, error: 'El n√∫mero debe tener 10 d√≠gitos despu√©s de +57' };
            }
            
            // Verificar que todos los caracteres despu√©s de +57 sean d√≠gitos
            const digits = phone.substring(3);
            if (!/^\d{10}$/.test(digits)) {
                return { valid: false, error: 'El n√∫mero debe contener solo d√≠gitos despu√©s de +57' };
            }
            
            return { valid: true, phone: phone };
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('No se pudo reproducir sonido');
            }
        }

        function showNewOrderNotification(order) {
            showAlert(`üéâ ¬°Nuevo pedido asignado! #${order.id.substring(0, 8)} - ${order.cliente}`, 'success');
            
            const badge = document.createElement('div');
            badge.className = 'new-order-badge';
            badge.textContent = 'üÜï Nuevo Pedido';
            document.body.appendChild(badge);
            
            setTimeout(() => badge.remove(), 5000);
            
            playNotificationSound();

            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }

            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Fluxi - Nuevo Pedido', {
                    body: `Pedido de ${order.cliente}\nTotal: ${formatCurrency(order.valor_pedido + order.valor_domicilio)}`,
                    icon: 'üèçÔ∏è',
                    badge: 'üì¶'
                });
            }
        }

        function setupRealtimeSubscription() {
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
            }

            realtimeChannel = supabase
                .channel('pedidos-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'pedidos'
                    },
                    async (payload) => {
                        console.log('Cambio detectado:', payload);
                        
                        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                            const newOrder = payload.new;
                            
                            if (newOrder.domiciliario_id === currentDelivery.id && 
                                newOrder.estado === 'asignado' &&
                                (!activeOrder || activeOrder.id !== newOrder.id)) {
                                showNewOrderNotification(newOrder);
                            }
                        }
                        
                        await loadOrders();
                    }
                )
                .subscribe();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', { 
                style: 'currency', 
                currency: 'COP', 
                minimumFractionDigits: 0 
            }).format(value);
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function startTimer(startTime = null) {
            if (timerInterval) return;
            
            // Si se proporciona un tiempo de inicio, usarlo; sino, usar el tiempo actual
            timerStartTime = startTime || Date.now();
            
            // Actualizar inmediatamente
            const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
            document.getElementById('timer-display').textContent = formatTime(elapsed);
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
                document.getElementById('timer-display').textContent = formatTime(elapsed);
            }, 1000);
            
            console.log('‚è±Ô∏è Temporizador iniciado desde:', new Date(timerStartTime).toLocaleTimeString());
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerStartTime = null;
            document.getElementById('timer-display').textContent = '00:00:00';
        }

        function requestLocationPermission() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalizaci√≥n no soportada'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    () => resolve(true),
                    (error) => reject(error),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function updateLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalizaci√≥n no disponible'));
                    return;
                }
                
                if (!currentDelivery) {
                    reject(new Error('No hay domiciliario activo'));
                    return;
                }

                console.log('üîÑ Solicitando ubicaci√≥n GPS...');

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            const locationData = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                timestamp: new Date().toISOString(),
                                accuracy: position.coords.accuracy,
                                speed: position.coords.speed,
                                heading: position.coords.heading
                            };

                            console.log('üìç Ubicaci√≥n GPS obtenida:', {
                                lat: locationData.lat.toFixed(6),
                                lng: locationData.lng.toFixed(6),
                                accuracy: Math.round(locationData.accuracy) + 'm',
                                timestamp: locationData.timestamp
                            });

                            console.log('üíæ Guardando en base de datos...');
                            const { data: updateResult, error: updateError } = await supabase
                                .from('domiciliarios')
                                .update({ 
                                    ubicacion: locationData,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', currentDelivery.id)
                                .select();

                            if (updateError) {
                                console.error('‚ùå Error al guardar ubicaci√≥n:', updateError);
                                throw updateError;
                            }

                            console.log('‚úÖ Ubicaci√≥n guardada exitosamente en BD:', updateResult);

                            // Verificar que se guard√≥ correctamente
                            const { data: verifyData, error: verifyError } = await supabase
                                .from('domiciliarios')
                                .select('ubicacion')
                                .eq('id', currentDelivery.id)
                                .single();

                            if (verifyData && verifyData.ubicacion) {
                                console.log('‚úÖ Verificaci√≥n: Ubicaci√≥n confirmada en BD:', {
                                    lat: verifyData.ubicacion.lat.toFixed(6),
                                    lng: verifyData.ubicacion.lng.toFixed(6),
                                    timestamp: verifyData.ubicacion.timestamp
                                });
                            } else {
                                console.warn('‚ö†Ô∏è Advertencia: No se pudo verificar la ubicaci√≥n en BD');
                            }

                            // Incrementar contador de actualizaciones
                            locationUpdateCount++;

                            document.getElementById('location-indicator').classList.add('active');
                            document.getElementById('location-indicator').classList.remove('inactive');
                            
                            const timeStr = new Date().toLocaleTimeString('es-CO', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            
                            document.getElementById('location-status').textContent = 
                                `Ubicaci√≥n activa - Actualizado: ${timeStr} (${locationUpdateCount} actualizaciones)`;
                            
                            // Actualizar UI del control de ubicaci√≥n
                            updateLocationUI(true);
                            
                            console.log(`üìç [${locationUpdateCount}] Ubicaci√≥n actualizada completamente:`, {
                                lat: locationData.lat.toFixed(6),
                                lng: locationData.lng.toFixed(6),
                                accuracy: Math.round(locationData.accuracy) + 'm',
                                time: timeStr
                            });
                            
                            resolve(locationData);
                        } catch (error) {
                            console.error('‚ùå Error actualizando ubicaci√≥n:', error);
                            reject(error);
                        }
                    },
                    (error) => {
                        console.error('‚ùå Error de geolocalizaci√≥n:', error);
                        let errorMessage = 'Error al obtener ubicaci√≥n. ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Permisos de ubicaci√≥n denegados.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Ubicaci√≥n no disponible.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Tiempo de espera agotado.';
                                break;
                            default:
                                errorMessage += error.message;
                        }
                        reject(new Error(errorMessage));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function updateLocationUI(active) {
            const control = document.getElementById('location-control');
            const warning = document.getElementById('location-warning');
            const info = document.getElementById('location-info');
            const message = document.getElementById('location-message');
            const btn = document.getElementById('btn-toggle-location');
            const btnText = document.getElementById('location-btn-text');
            const btnIcon = document.getElementById('location-btn-icon');
            const indicator = document.getElementById('location-indicator-main');
            const statusDetail = document.getElementById('location-status-detail');

            if (active) {
                control.classList.remove('inactive');
                control.classList.add('active');
                warning.classList.add('hidden');
                info.classList.remove('hidden');
                message.textContent = 'üîÑ Tu ubicaci√≥n se actualiza cada 10 segundos';
                message.classList.add('success');
                btn.classList.remove('activate');
                btn.classList.add('deactivate');
                btnText.textContent = 'Desactivar Ubicaci√≥n';
                btnIcon.textContent = 'üõë';
                indicator.classList.remove('inactive');
                indicator.classList.add('active');
                
                const timeStr = new Date().toLocaleTimeString('es-CO', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                statusDetail.textContent = `Actualizado: ${timeStr} | Total: ${locationUpdateCount} actualizaciones`;
            } else {
                control.classList.remove('active');
                control.classList.add('inactive');
                warning.classList.remove('hidden');
                info.classList.add('hidden');
                message.textContent = 'Toca el bot√≥n para compartir tu ubicaci√≥n';
                message.classList.remove('success');
                btn.classList.remove('deactivate');
                btn.classList.add('activate');
                btnText.textContent = 'Activar Ubicaci√≥n';
                btnIcon.textContent = 'üìç';
                indicator.classList.remove('active');
                indicator.classList.add('inactive');
                statusDetail.textContent = '';
            }
        }

        async function startLocationTracking() {
            try {
                console.log('üîÑ ========== INICIANDO SEGUIMIENTO DE UBICACI√ìN ==========');
                console.log('   Hora de inicio:', new Date().toLocaleTimeString('es-CO'));
                
                // Paso 1: Solicitar permiso de ubicaci√≥n
                await requestLocationPermission();
                console.log('‚úÖ Permisos de ubicaci√≥n obtenidos');
                
                // Paso 2: Obtener ubicaci√≥n inicial y verificar que funcione
                await updateLocation();
                console.log('‚úÖ Ubicaci√≥n inicial obtenida exitosamente');

                // Paso 3: Intentar activar Wake Lock (opcional, para mejor tracking en background)
                console.log('üîã Intentando activar Wake Lock para mejorar tracking en segundo plano...');
                const wakeLockActivated = await requestWakeLock();
                if (wakeLockActivated) {
                    console.log('‚úÖ Wake Lock activado - mejor tracking en segundo plano');
                } else {
                    console.log('‚ÑπÔ∏è Wake Lock no disponible - el tracking seguir√° funcionando normalmente');
                }

                // Paso 4: Configurar actualizaciones peri√≥dicas cada 15 segundos
                console.log('‚è±Ô∏è Configurando actualizaciones autom√°ticas cada 15 segundos...');
                locationUpdateInterval = setInterval(async () => {
                    try {
                        const bgStatus = isAppInBackground ? '[BACKGROUND]' : '[FOREGROUND]';
                        console.log(`‚è∞ ${bgStatus} [INTERVALO] Ejecutando actualizaci√≥n autom√°tica...`);
                        
                        // üî¥ VERIFICACI√ìN CR√çTICA: Solo actualizar si hay un pedido activo
                        if (!activeOrder) {
                            console.log(`‚ÑπÔ∏è ${bgStatus} [INTERVALO] No hay pedido activo, omitiendo actualizaci√≥n para ahorrar bater√≠a`);
                            return;
                        }
                        
                        console.log(`üìç ${bgStatus} [INTERVALO] Pedido activo #${activeOrder.id.substring(0, 8)} - Estado: ${activeOrder.estado}`);
                        
                        await updateLocation();
                        
                        if (isAppInBackground) {
                            backgroundUpdateCount++;
                            console.log(`‚úÖ ${bgStatus} [INTERVALO] Actualizaci√≥n completada (${backgroundUpdateCount} en background)`);
                        } else {
                            console.log(`‚úÖ ${bgStatus} [INTERVALO] Actualizaci√≥n completada`);
                        }
                    } catch (error) {
                        console.error('‚ùå [INTERVALO] Error en actualizaci√≥n peri√≥dica:', error);
                    }
                }, 15000); // 15 segundos

                console.log('‚úÖ Intervalo de actualizaci√≥n configurado (ID:', locationUpdateInterval, ')');

                // Paso 5: Configurar watchPosition para actualizaciones EN MOVIMIENTO
                // Con opciones optimizadas para funcionar en segundo plano
                console.log('üëÄ Configurando watchPosition para actualizaciones continuas...');
                locationWatchId = navigator.geolocation.watchPosition(
                    async (position) => {
                        try {
                            const bgStatus = isAppInBackground ? '[BACKGROUND]' : '[FOREGROUND]';
                            console.log(`üö∂ ${bgStatus} [WATCHPOSITION] Cambio de posici√≥n detectado`);
                            
                            // üî¥ VERIFICACI√ìN CR√çTICA: Solo actualizar si hay un pedido activo
                            if (!activeOrder) {
                                console.log(`‚ÑπÔ∏è ${bgStatus} [WATCHPOSITION] No hay pedido activo, omitiendo actualizaci√≥n`);
                                return;
                            }
                            
                            console.log(`üìç ${bgStatus} [WATCHPOSITION] Pedido activo #${activeOrder.id.substring(0, 8)} - Actualizando...`);
                            
                            const locationData = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                timestamp: new Date().toISOString(),
                                accuracy: position.coords.accuracy,
                                speed: position.coords.speed,
                                heading: position.coords.heading
                            };

                            console.log(`üíæ ${bgStatus} [WATCHPOSITION] Guardando nueva ubicaci√≥n:`, {
                                lat: locationData.lat.toFixed(6),
                                lng: locationData.lng.toFixed(6),
                                accuracy: Math.round(locationData.accuracy) + 'm'
                            });

                            const { data, error } = await supabase
                                .from('domiciliarios')
                                .update({ 
                                    ubicacion: locationData,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', currentDelivery.id)
                                .select();

                            if (error) {
                                console.error(`‚ùå ${bgStatus} [WATCHPOSITION] Error al guardar:`, error);
                            } else {
                                console.log(`‚úÖ ${bgStatus} [WATCHPOSITION] Ubicaci√≥n guardada en BD`);
                            }

                            // Incrementar contador
                            locationUpdateCount++;
                            if (isAppInBackground) {
                                backgroundUpdateCount++;
                            }

                            // Solo actualizar UI si est√° en foreground
                            if (!isAppInBackground) {
                                document.getElementById('location-indicator').classList.add('active');
                                document.getElementById('location-indicator').classList.remove('inactive');
                                
                                const timeStr = new Date().toLocaleTimeString('es-CO', { 
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    second: '2-digit'
                                });
                                
                                document.getElementById('location-status').textContent = 
                                    `Ubicaci√≥n activa - Actualizado: ${timeStr} (${locationUpdateCount} actualizaciones)`;
                                
                                // Actualizar UI del control de ubicaci√≥n
                                updateLocationUI(true);
                            }
                            
                            console.log(`‚úÖ ${bgStatus} [WATCHPOSITION] Actualizaci√≥n #${locationUpdateCount} completada`);
                        } catch (error) {
                            console.error('‚ùå [WATCHPOSITION] Error:', error);
                        }
                    },
                    (error) => {
                        console.error('‚ùå [WATCHPOSITION] Error de watchPosition:', error.code, error.message);
                        // No mostrar alert si est√° en background para no molestar al usuario
                        if (!isAppInBackground) {
                            showAlert('‚ö†Ô∏è Error continuo de ubicaci√≥n. Verifica tus permisos.', 'warning');
                        }
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 30000, // 30 segundos - m√°s tiempo para background
                        maximumAge: 0
                    }
                );

                console.log('‚úÖ watchPosition configurado (ID:', locationWatchId, ')');
                console.log('‚úÖ ========== SEGUIMIENTO DE UBICACI√ìN INICIADO ==========');
                console.log('üìç Sistema activo con:');
                console.log('   - Actualizaci√≥n autom√°tica cada 15 segundos');
                console.log('   - WatchPosition para detectar movimiento');
                console.log('   - Soporte para tracking en segundo plano');
                console.log('   - Wake Lock:', wakeLock ? 'Activo' : 'No disponible');
                console.log('   - Total actualizaciones hasta ahora:', locationUpdateCount);
                
                isLocationActive = true;
                backgroundUpdateCount = 0; // Resetear contador de background
                updateLocationUI(true);
                return true;
                
            } catch (error) {
                console.error('‚ùå ========== ERROR AL INICIAR SEGUIMIENTO ==========');
                console.error('Error completo:', error);
                
                // Limpiar cualquier configuraci√≥n parcial
                stopLocationTracking();
                
                // Mostrar mensaje espec√≠fico seg√∫n el error
                let errorMessage = '';
                if (error.code === 1 || error.message.includes('denegados') || error.message.includes('denied')) {
                    errorMessage = '‚ùå PERMISOS DENEGADOS\n\n' +
                                  'üì± Para activar permisos de ubicaci√≥n:\n\n' +
                                  '1. Haz clic en el √≠cono üîí o ‚ìò en la barra de direcciones\n' +
                                  '2. Busca "Ubicaci√≥n" o "Location"\n' +
                                  '3. Selecciona "Permitir"\n' +
                                  '4. Recarga la p√°gina\n\n' +
                                  'IMPORTANTE: Sin ubicaci√≥n activa no puedes aceptar pedidos.';
                } else if (error.code === 2 || error.message.includes('no disponible') || error.message.includes('unavailable')) {
                    errorMessage = '‚ùå GPS NO DISPONIBLE\n\n' +
                                  'üì° Verifica que:\n' +
                                  '1. El GPS est√© activado en tu dispositivo\n' +
                                  '2. Est√©s al aire libre o cerca de una ventana\n' +
                                  '3. No est√©s en modo avi√≥n\n\n' +
                                  'Intenta nuevamente cuando el GPS est√© disponible.';
                } else if (error.code === 3 || error.message.includes('Tiempo de espera') || error.message.includes('timeout')) {
                    errorMessage = '‚ùå TIEMPO DE ESPERA AGOTADO\n\n' +
                                  '‚è±Ô∏è La ubicaci√≥n tard√≥ demasiado en obtenerse.\n\n' +
                                  'Esto puede ser por:\n' +
                                  '‚Ä¢ Mala se√±al GPS\n' +
                                  '‚Ä¢ Est√°s en un lugar cerrado\n' +
                                  '‚Ä¢ Conexi√≥n lenta\n\n' +
                                  'Ve a un lugar con mejor se√±al e intenta de nuevo.';
                } else {
                    errorMessage = '‚ùå ERROR AL ACTIVAR UBICACI√ìN\n\n' + error.message + '\n\nIntenta recargar la p√°gina.';
                }
                
                alert(errorMessage);
                isLocationActive = false;
                updateLocationUI(false);
                return false;
            }
        }

        function stopLocationTracking() {
            console.log('üõë ========== DETENIENDO SEGUIMIENTO DE UBICACI√ìN ==========');
            
            if (locationWatchId) {
                console.log('   üóëÔ∏è Limpiando watchPosition (ID:', locationWatchId, ')');
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
                console.log('   ‚úÖ watchPosition detenido');
            } else {
                console.log('   ‚ÑπÔ∏è No hab√≠a watchPosition activo');
            }
            
            if (locationUpdateInterval) {
                console.log('   üóëÔ∏è Limpiando intervalo de actualizaci√≥n (ID:', locationUpdateInterval, ')');
                clearInterval(locationUpdateInterval);
                locationUpdateInterval = null;
                console.log('   ‚úÖ Intervalo de actualizaci√≥n detenido');
            } else {
                console.log('   ‚ÑπÔ∏è No hab√≠a intervalo activo');
            }
            
            // Liberar Wake Lock si est√° activo
            if (wakeLock) {
                console.log('   üîã Liberando Wake Lock...');
                releaseWakeLock();
                console.log('   ‚úÖ Wake Lock liberado');
            } else {
                console.log('   ‚ÑπÔ∏è No hab√≠a Wake Lock activo');
            }
            
            document.getElementById('location-indicator').classList.remove('active');
            document.getElementById('location-indicator').classList.add('inactive');
            document.getElementById('location-status').textContent = 'Ubicaci√≥n desactivada';
            
            // Mostrar estad√≠sticas
            console.log('   üìä Total de actualizaciones realizadas:', locationUpdateCount);
            console.log('   üìä Actualizaciones en segundo plano:', backgroundUpdateCount);
            console.log('   üìä Actualizaciones en primer plano:', locationUpdateCount - backgroundUpdateCount);
            
            // Resetear contadores
            locationUpdateCount = 0;
            backgroundUpdateCount = 0;
            
            // Actualizar estado y UI
            isLocationActive = false;
            updateLocationUI(false);
            
            console.log('‚úÖ ========== SEGUIMIENTO DE UBICACI√ìN DETENIDO ==========');
        }

        window.toggleLocation = async function() {
            const btn = document.getElementById('btn-toggle-location');
            
            if (isLocationActive) {
                // Desactivar ubicaci√≥n
                if (activeOrder) {
                    showAlert('‚ö†Ô∏è No puedes desactivar la ubicaci√≥n mientras tienes un pedido activo.', 'warning');
                    return;
                }
                
                if (confirm('¬øEst√°s seguro de desactivar tu ubicaci√≥n? No podr√°s aceptar pedidos hasta que la vuelvas a activar.')) {
                    stopLocationTracking();
                    showAlert('‚úÖ Ubicaci√≥n desactivada', 'info');
                }
            } else {
                // Activar ubicaci√≥n
                btn.disabled = true;
                const btnText = document.getElementById('location-btn-text');
                const btnIcon = document.getElementById('location-btn-icon');
                btnText.textContent = 'Activando...';
                
                try {
                    const success = await startLocationTracking();
                    if (success) {
                        showAlert('‚úÖ ¬°Ubicaci√≥n activada! Ahora puedes aceptar pedidos.', 'success');
                    }
                } catch (error) {
                    showAlert('‚ùå Error al activar ubicaci√≥n: ' + error.message, 'danger');
                } finally {
                    btn.disabled = false;
                    if (isLocationActive) {
                        btnText.textContent = 'Desactivar Ubicaci√≥n';
                        btnIcon.textContent = 'üõë';
                    } else {
                        btnText.textContent = 'Activar Ubicaci√≥n';
                        btnIcon.textContent = 'üìç';
                    }
                }
            }
        };

        async function login(phone) {
            const loginBtn = document.getElementById('login-btn');
            const phoneInput = document.getElementById('login-phone');
            
            try {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Verificando...';
                
                // Validar formato de tel√©fono
                const validation = validatePhone(phone);
                if (!validation.valid) {
                    phoneInput.classList.add('error');
                    throw new Error(validation.error);
                }
                
                phoneInput.classList.remove('error');
                const cleanPhone = validation.phone;
                
                console.log('Intentando login con tel√©fono:', cleanPhone);
                
                // Buscar domiciliario
                const { data, error } = await supabase
                    .from('domiciliarios')
                    .select('*')
                    .eq('telefono', cleanPhone)
                    .maybeSingle();

                console.log('Resultado de b√∫squeda:', { data, error });

                if (error) {
                    console.error('Error de Supabase:', error);
                    throw new Error('Error al conectar con el servidor: ' + error.message);
                }

                if (!data) {
                    phoneInput.classList.add('error');
                    throw new Error(`‚ùå N√∫mero ${cleanPhone} no registrado en el sistema.\n\nVerifica que:\n‚Ä¢ El n√∫mero est√© registrado\n‚Ä¢ Incluya +57 seguido de 10 d√≠gitos\n‚Ä¢ No tenga espacios ni guiones`);
                }

                currentDelivery = data;
                localStorage.setItem('fluxi_delivery', JSON.stringify(data));
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('delivery-name').textContent = data.nombre;

                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }

                setupRealtimeSubscription();

                await loadOrders();
                setInterval(loadOrders, 30000);
                
                showAlert(`‚úÖ ¬°Bienvenido ${data.nombre}!`, 'success');
                
            } catch (error) {
                console.error('Error en login:', error);
                showAlert(error.message, 'danger');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
            }
        }

        async function loadOrders() {
            if (!currentDelivery) return;

            try {
                // Obtener TODOS los pedidos asignados, ordenados por tiempo de aceptaci√≥n (el primero aceptado primero)
                const { data: activeOrders } = await supabase
                    .from('pedidos')
                    .select('*')
                    .eq('domiciliario_id', currentDelivery.id)
                    .in('estado', ['asignado', 'en_camino'])
                    .order('tiempo_aceptacion', { ascending: true }); // Primero el que fue aceptado primero

                if (activeOrders && activeOrders.length > 0) {
                    console.log(`üì¶ ${activeOrders.length} pedido(s) asignado(s)`);

                    // Renderizar TODOS los pedidos activos
                    renderActiveOrders(activeOrders);

                    // ‚úÖ NO ACTIVAR UBICACI√ìN AUTOM√ÅTICAMENTE
                    // El domiciliario debe activarla manualmente con el bot√≥n
                    if (!isLocationActive) {
                        console.log('‚ÑπÔ∏è Pedidos activos detectados. Recuerda activar tu ubicaci√≥n con el bot√≥n verde.');
                        // Mostrar recordatorio visual si la ubicaci√≥n no est√° activa
                        const hayPedidosEnCamino = activeOrders.some(o => o.estado === 'en_camino');
                        if (hayPedidosEnCamino) {
                            showAlert('üìç Recuerda activar tu ubicaci√≥n con el bot√≥n verde para que puedan rastrearte.', 'warning');
                        }
                    }

                    // Iniciar temporizador si hay pedidos en camino
                    const primerPedidoEnCamino = activeOrders.find(o => o.estado === 'en_camino');
                    if (primerPedidoEnCamino && !timerInterval) {
                        const startTime = primerPedidoEnCamino.tiempo_inicio || Date.now();
                        console.log('‚è±Ô∏è Recuperando temporizador desde:', new Date(startTime).toLocaleTimeString());
                        startTimer(startTime);
                    }
                } else {
                    activeOrder = null;
                    document.getElementById('active-order-container').classList.add('hidden');
                    stopTimer();

                    await supabase
                        .from('domiciliarios')
                        .update({ estado: 'disponible' })
                        .eq('id', currentDelivery.id);
                }

                // ‚úÖ Filtrar pedidos seg√∫n el tipo de domiciliario
                // Solo mostrar pedidos del tipo correspondiente (propio/rappi)
                const { data: availableOrders } = await supabase
                    .from('pedidos')
                    .select('*')
                    .eq('estado', 'pendiente')
                    .is('domiciliario_id', null)
                    .eq('tipo_domiciliario', currentDelivery.tipo || 'propio')
                    .order('created_at', { ascending: false });

                renderAvailableOrders(availableOrders || []);

                await updateStats();
            } catch (error) {
                console.error('Error cargando pedidos:', error);
            }
        }

        function renderActiveOrders(orders) {
            document.getElementById('active-order-container').classList.remove('hidden');
            document.getElementById('available-orders-container').classList.add('hidden');

            // Generar HTML para todos los pedidos
            const cardsHTML = orders.map((order, index) => `
                <div class="order-card active" style="margin-bottom: 15px;">
                    <div class="order-header">
                        <div class="order-id">#${index + 1} - ${order.id.substring(0, 8)}</div>
                        <span class="order-status ${order.estado}">${order.estado === 'asignado' ? 'Asignado' : 'En Camino'}</span>
                    </div>
                    <div class="order-detail">
                        <div class="order-detail-row">
                            <div class="order-detail-label">üë§ Cliente:</div>
                            <div class="order-detail-value">${order.cliente}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üìû Tel√©fono:</div>
                            <div class="order-detail-value">${order.telefono_cliente}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üìç Direcci√≥n:</div>
                            <div class="order-detail-value">${order.direccion}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üèòÔ∏è Barrio:</div>
                            <div class="order-detail-value">${order.barrio || 'No especificado'}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üí∞ Total:</div>
                            <div class="order-detail-value">${formatCurrency(order.valor_pedido + order.valor_domicilio)}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üí≥ Pago:</div>
                            <div class="order-detail-value">${order.metodo_pago === 'efectivo' ? 'Efectivo' : 'Tarjeta'}</div>
                        </div>
                        ${order.notas ? `
                        <div class="order-detail-row">
                            <div class="order-detail-label">üìù Notas:</div>
                            <div class="order-detail-value">${order.notas}</div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="action-buttons">
                        ${order.estado === 'asignado' ? `
                            <button class="btn btn-success" onclick="window.startDeliveryRoute('${order.id}')">
                                üöÄ Iniciar Ruta
                            </button>
                        ` : ''}
                        ${order.estado === 'en_camino' ? `
                            <button class="btn btn-primary" onclick="window.completeDelivery('${order.id}')">
                                ‚úÖ Marcar Entregado
                            </button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="window.cancelOrder('${order.id}')" style="margin-top: 10px;">
                            ‚ùå Cancelar Pedido
                        </button>
                    </div>
                </div>
            `).join('');

            // Actualizar el t√≠tulo del contenedor
            const tituloContainer = document.querySelector('#active-order-container h2');
            if (tituloContainer) {
                tituloContainer.textContent = orders.length > 1
                    ? `üì¶ Mis Pedidos (${orders.length})`
                    : 'üì¶ Pedido Activo';
            }

            document.getElementById('active-order-card').innerHTML = cardsHTML;
        }

        function renderAvailableOrders(orders) {
            const container = document.getElementById('orders-list');
            
            if (!activeOrder) {
                document.getElementById('available-orders-container').classList.remove('hidden');
            }

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-text">No hay pedidos disponibles</div>
                        <div class="empty-state-subtext">Los nuevos pedidos aparecer√°n aqu√≠ autom√°ticamente</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-id">#${order.id.substring(0, 8)}</div>
                        <span class="order-status pendiente">Disponible</span>
                    </div>
                    <div class="order-detail">
                        <div class="order-detail-row">
                            <div class="order-detail-label">üë§ Cliente:</div>
                            <div class="order-detail-value">${order.cliente}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üìç Direcci√≥n:</div>
                            <div class="order-detail-value">${order.direccion}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üí∞ Total:</div>
                            <div class="order-detail-value">${formatCurrency(order.valor_pedido + order.valor_domicilio)}</div>
                        </div>
                        <div class="order-detail-row">
                            <div class="order-detail-label">üí≥ Pago:</div>
                            <div class="order-detail-value">${order.metodo_pago === 'efectivo' ? 'Efectivo' : 'Tarjeta'}</div>
                        </div>
                    </div>
                    ${!isLocationActive ? `
                        <div style="padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; margin-bottom: 10px; font-size: 13px; color: #2980b9; border-left: 3px solid #3498db;">
                            ‚ÑπÔ∏è Al aceptar este pedido, tu ubicaci√≥n se activar√° autom√°ticamente para rastrear la entrega
                        </div>
                    ` : ''}
                    <button class="btn btn-primary" onclick="window.acceptOrder('${order.id}')">
                        ‚úÖ Aceptar Pedido
                    </button>
                </div>
            `).join('');
        }

        async function updateStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const { data: allOrders } = await supabase
                .from('pedidos')
                .select('*')
                .eq('domiciliario_id', currentDelivery.id);

            const todayOrders = (allOrders || []).filter(o => 
                new Date(o.created_at) >= today
            );

            const completed = (allOrders || []).filter(o => o.estado === 'entregado').length;
            const active = (allOrders || []).filter(o => 
                o.estado === 'asignado' || o.estado === 'en_camino'
            ).length;

            document.getElementById('orders-today').textContent = todayOrders.length;
            document.getElementById('orders-completed').textContent = completed;
            document.getElementById('orders-active').textContent = active;

            // Actualizar cuadre de caja
            await updateCashBalance();
        }

        async function updateCashBalance() {
            if (!currentDelivery) return;

            try {
                // Obtener fecha actual y calcular el inicio del d√≠a laboral (8 AM)
                const ahora = new Date();
                const today = new Date().toISOString().split('T')[0];

                // Calcular inicio del d√≠a laboral (hoy a las 8 AM)
                const inicioDiaLaboral = new Date(today + 'T08:00:00');

                // Si a√∫n no son las 8 AM de hoy, usar las 8 AM de ayer
                let fechaInicio;
                let fechaConfiguracion = today;

                if (ahora < inicioDiaLaboral) {
                    // Estamos antes de las 8 AM, mostrar datos desde las 8 AM de ayer
                    const ayer = new Date(ahora);
                    ayer.setDate(ayer.getDate() - 1);
                    const ayerStr = ayer.toISOString().split('T')[0];
                    fechaInicio = new Date(ayerStr + 'T08:00:00');
                    fechaConfiguracion = ayerStr; // Usar configuraci√≥n de ayer

                    console.log('‚è∞ Antes de las 8 AM - Mostrando cuadre desde las 8 AM de ayer');
                } else {
                    // Despu√©s de las 8 AM, mostrar datos desde las 8 AM de hoy
                    fechaInicio = inicioDiaLaboral;

                    console.log('‚è∞ Despu√©s de las 8 AM - Mostrando cuadre desde las 8 AM de hoy');
                }

                // Fecha fin es el momento actual
                const fechaFin = new Date();

                console.log('üìÖ Rango de cuadre:', {
                    inicio: fechaInicio.toLocaleString('es-CO'),
                    fin: fechaFin.toLocaleString('es-CO')
                });

                // Obtener valor de arranque del d√≠a laboral actual
                const { data: config } = await supabase
                    .from('configuracion_diaria')
                    .select('valor_arranque')
                    .eq('fecha', fechaConfiguracion)
                    .eq('domiciliario_id', currentDelivery.id)
                    .single();

                const valorArranque = config?.valor_arranque || 0;

                // Obtener pedidos entregados desde las 8 AM del d√≠a laboral actual
                const { data: pedidosEntregados } = await supabase
                    .from('pedidos')
                    .select('*')
                    .eq('domiciliario_id', currentDelivery.id)
                    .eq('estado', 'entregado')
                    .gte('created_at', fechaInicio.toISOString())
                    .lte('created_at', fechaFin.toISOString());

                // Calcular efectivo y tarjetas
                let efectivoRecaudado = 0;
                let tarjetasTotal = 0;
                let numeroDatafono = null;

                (pedidosEntregados || []).forEach(pedido => {
                    const valorDomicilio = pedido.valor_domicilio || 0;

                    if (pedido.metodo_pago === 'efectivo') {
                        efectivoRecaudado += valorDomicilio;
                    } else if (pedido.metodo_pago === 'tarjeta') {
                        tarjetasTotal += valorDomicilio;
                        if (pedido.numero_datafono && !numeroDatafono) {
                            numeroDatafono = pedido.numero_datafono;
                        }
                    }
                });

                const totalEfectivo = valorArranque + efectivoRecaudado;
                const totalGeneral = totalEfectivo + tarjetasTotal;

                // Actualizar UI
                document.getElementById('balance-arranque').textContent = formatCurrency(valorArranque);
                document.getElementById('balance-efectivo').textContent = formatCurrency(efectivoRecaudado);
                document.getElementById('balance-total-efectivo').textContent = formatCurrency(totalEfectivo);
                document.getElementById('balance-tarjetas').textContent = formatCurrency(tarjetasTotal);
                document.getElementById('balance-total-general').textContent = formatCurrency(totalGeneral);

                // Actualizar info del dat√°fono
                const datafonoInfo = numeroDatafono ? `Dat√°fono: ${numeroDatafono}` : 'Sin dat√°fono asignado';
                document.getElementById('balance-datafono-info').textContent = datafonoInfo;

                // Actualizar texto del per√≠odo
                const periodInfo = ahora < inicioDiaLaboral
                    ? '‚è∞ Desde las 8:00 AM de ayer (Antes del corte de hoy)'
                    : '‚è∞ Desde las 8:00 AM de hoy';
                document.getElementById('balance-period-info').textContent = periodInfo;

                console.log('üí∞ Cuadre actualizado:', {
                    valorArranque,
                    efectivoRecaudado,
                    totalEfectivo,
                    tarjetasTotal,
                    totalGeneral,
                    numeroDatafono
                });

            } catch (error) {
                console.error('‚ùå Error actualizando cuadre de caja:', error);
            }
        }

        window.acceptOrder = async function(orderId) {
            if (activeOrder) {
                showAlert('Ya tienes un pedido activo. Compl√©talo antes de aceptar otro.', 'warning');
                return;
            }

            // CR√çTICO: Verificar que la ubicaci√≥n est√© activa, si no, activarla autom√°ticamente
            if (!isLocationActive) {
                console.log('üìç Ubicaci√≥n no activa, activando autom√°ticamente...');
                showAlert('üîÑ Activando tu ubicaci√≥n autom√°ticamente...', 'info');
                
                try {
                    const locationActivated = await startLocationTracking();
                    if (!locationActivated) {
                        throw new Error('No se pudo activar la ubicaci√≥n');
                    }
                    console.log('‚úÖ Ubicaci√≥n activada exitosamente');
                    // Esperar 2 segundos para asegurar que se obtenga la primera ubicaci√≥n
                    await new Promise(resolve => setTimeout(resolve, 2000));
                } catch (error) {
                    console.error('‚ùå Error al activar ubicaci√≥n:', error);
                    showAlert('‚ùå No se pudo activar tu ubicaci√≥n. Por favor, act√≠vala manualmente con el bot√≥n verde arriba.', 'danger');
                    return;
                }
            }

            // Deshabilitar bot√≥n temporalmente para evitar m√∫ltiples clicks
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            try {
                console.log('üîç Iniciando proceso de aceptaci√≥n de pedido:', orderId);
                
                // Verificar que efectivamente tenemos una ubicaci√≥n guardada y reciente
                const { data: deliveryData } = await supabase
                    .from('domiciliarios')
                    .select('ubicacion')
                    .eq('id', currentDelivery.id)
                    .single();

                console.log('üîç deliveryData:', deliveryData);

                if (!deliveryData || !deliveryData.ubicacion || !deliveryData.ubicacion.lat) {
                    throw new Error('‚ö†Ô∏è No se detect√≥ tu ubicaci√≥n.\n\n' +
                                    '1. Aseg√∫rate de haber activado tu ubicaci√≥n (bot√≥n verde arriba)\n' +
                                    '2. Espera unos segundos a que el GPS se active\n' +
                                    '3. Intenta aceptar el pedido nuevamente\n\n' +
                                    'Si el problema persiste, recarga la p√°gina.');
                }

                // Verificar que la ubicaci√≥n sea reciente (menos de 5 minutos)
                const locationTimestamp = new Date(deliveryData.ubicacion.timestamp);
                const now = new Date();
                const diffMinutes = (now - locationTimestamp) / 1000 / 60;
                
                if (diffMinutes > 5) {
                    throw new Error('‚ö†Ô∏è Tu ubicaci√≥n no est√° actualizada (√∫ltima actualizaci√≥n hace ' + Math.round(diffMinutes) + ' minutos).\n\n' +
                                    '1. Verifica que el bot√≥n de ubicaci√≥n est√© verde\n' +
                                    '2. Espera unos segundos\n' +
                                    '3. Intenta aceptar el pedido nuevamente\n\n' +
                                    'Si el problema persiste, desactiva y vuelve a activar tu ubicaci√≥n.');
                }

                console.log('‚úÖ Ubicaci√≥n verificada y actual:', deliveryData.ubicacion);

                // Aceptar el pedido
                const updateData = {
                    estado: 'asignado',
                    domiciliario_id: currentDelivery.id,
                    domiciliario_nombre: currentDelivery.nombre,
                    domiciliario_telefono: currentDelivery.telefono,
                    tiempo_aceptacion: Date.now(),
                    updated_at: new Date().toISOString()
                };
                
                console.log('üìù Actualizando pedido con datos:', updateData);
                
                const { data: updatedOrder, error } = await supabase
                    .from('pedidos')
                    .update(updateData)
                    .eq('id', orderId)
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Error al actualizar pedido:', error);
                    throw error;
                }
                
                console.log('‚úÖ Pedido actualizado exitosamente:', updatedOrder);

                // Actualizar estado del domiciliario
                const { error: deliveryError } = await supabase
                    .from('domiciliarios')
                    .update({ estado: 'ocupado' })
                    .eq('id', currentDelivery.id);
                    
                if (deliveryError) {
                    console.error('‚ö†Ô∏è Error al actualizar estado del domiciliario:', deliveryError);
                }

                showAlert('‚úÖ ¬°Pedido aceptado! Tu ubicaci√≥n est√° siendo rastreada autom√°ticamente. Recuerda iniciar la entrega cuando salgas.', 'success');
                
                console.log('üîÑ Recargando pedidos...');
                await loadOrders();
                console.log('‚úÖ Pedidos recargados');
                
            } catch (error) {
                console.error('‚ùå Error al aceptar el pedido:', error);
                showAlert('‚ùå Error: ' + error.message, 'danger');
                
                // Si fall√≥, verificar que la ubicaci√≥n siga activa
                if (!isLocationActive) {
                    stopLocationTracking();
                }
            } finally {
                // Rehabilitar botones
                buttons.forEach(btn => btn.disabled = false);
            }
        };

        /**
         * Iniciar ruta de entrega - Cuando hay m√∫ltiples pedidos, todos inician juntos
         */
        window.startDeliveryRoute = async function(triggeredOrderId) {
            console.log('üöÄ ========== INICIANDO RUTA DE ENTREGA ==========');
            console.log('   - Pedido que dispar√≥ la ruta:', triggeredOrderId);

            // üîí VALIDACI√ìN: Verificar que la ubicaci√≥n est√© activa
            if (!isLocationActive) {
                console.warn('‚ö†Ô∏è Intento de iniciar ruta sin ubicaci√≥n activa');
                showAlert('‚ö†Ô∏è Debes tener la ubicaci√≥n activada para iniciar la ruta. Por favor activa tu ubicaci√≥n primero.', 'warning');
                return;
            }

            // Deshabilitar botones temporalmente
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            try {
                const startTime = Date.now();
                console.log('   - Tiempo de inicio:', new Date(startTime).toLocaleTimeString());

                // Obtener TODOS los pedidos asignados al domiciliario
                const { data: pedidosAsignados, error: fetchError } = await supabase
                    .from('pedidos')
                    .select('*')
                    .eq('domiciliario_id', currentDelivery.id)
                    .eq('estado', 'asignado');

                if (fetchError) throw fetchError;

                console.log(`   - Se encontraron ${pedidosAsignados.length} pedido(s) asignado(s)`);
                console.log('   - Pedidos:', pedidosAsignados.map(p => p.id.substring(0, 8)));

                // Actualizar TODOS los pedidos asignados a "en_camino" con el mismo tiempo de inicio
                const pedidosIds = pedidosAsignados.map(p => p.id);

                const { data: updatedOrders, error: updateError } = await supabase
                    .from('pedidos')
                    .update({
                        estado: 'en_camino',
                        tiempo_inicio: startTime,
                        updated_at: new Date().toISOString()
                    })
                    .in('id', pedidosIds)
                    .select();

                if (updateError) {
                    console.error('‚ùå Error al actualizar pedidos:', updateError);
                    throw updateError;
                }

                console.log(`‚úÖ ${updatedOrders.length} pedido(s) actualizado(s) a "en_camino"`);

                // Iniciar el temporizador compartido
                startTimer(startTime);

                showAlert(`‚úÖ ¬°Ruta iniciada! ${updatedOrders.length} pedido(s) en camino. El temporizador est√° corriendo.`, 'success');

                console.log('üîÑ Recargando pedidos...');
                await loadOrders();
                console.log('‚úÖ ========== RUTA INICIADA EXITOSAMENTE ==========');

            } catch (error) {
                console.error('‚ùå ========== ERROR AL INICIAR RUTA ==========');
                console.error('Error completo:', error);
                showAlert('‚ùå Error al iniciar ruta: ' + error.message, 'danger');
            } finally {
                // Rehabilitar botones
                buttons.forEach(btn => btn.disabled = false);
            }
        };

        window.startDelivery = async function(orderId) {
            console.log('üöÄ ========== INICIANDO ENTREGA ==========');
            console.log('   - Pedido ID:', orderId);
            
            // üîí VALIDACI√ìN: Verificar que la ubicaci√≥n est√© activa
            if (!isLocationActive) {
                console.warn('‚ö†Ô∏è Intento de iniciar entrega sin ubicaci√≥n activa');
                showAlert('‚ö†Ô∏è Debes tener la ubicaci√≥n activada para iniciar la entrega. Por favor activa tu ubicaci√≥n primero.', 'warning');
                return;
            }
            
            // Deshabilitar botones temporalmente
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            
            try {
                const startTime = Date.now();
                console.log('   - Tiempo de inicio:', new Date(startTime).toLocaleTimeString());
                
                const updateData = {
                    estado: 'en_camino',
                    updated_at: new Date().toISOString()
                };
                
                console.log('   - Datos a actualizar:', updateData);
                
                const { data: updatedOrder, error } = await supabase
                    .from('pedidos')
                    .update(updateData)
                    .eq('id', orderId)
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Error de Supabase:', error);
                    throw error;
                }
                
                console.log('‚úÖ Pedido actualizado:', updatedOrder);

                startTimer(startTime);
                showAlert('‚úÖ ¬°Entrega iniciada! El temporizador est√° corriendo.', 'success');
                
                console.log('üîÑ Recargando pedidos...');
                await loadOrders();
                console.log('‚úÖ ========== ENTREGA INICIADA EXITOSAMENTE ==========');
                
            } catch (error) {
                console.error('‚ùå ========== ERROR AL INICIAR ENTREGA ==========');
                console.error('Error completo:', error);
                showAlert('‚ùå Error al iniciar entrega: ' + error.message, 'danger');
            } finally {
                // Rehabilitar botones
                buttons.forEach(btn => btn.disabled = false);
            }
        };

        window.completeDelivery = async function(orderId) {
            console.log('‚úÖ ========== COMPLETANDO ENTREGA ==========');
            console.log('   - Pedido ID:', orderId);
            
            // VALIDACI√ìN: Verificar que el pedido est√© en estado "en_camino"
            if (activeOrder && activeOrder.estado !== 'en_camino') {
                console.warn('‚ö†Ô∏è Intento de completar pedido sin iniciar');
                showAlert('‚ö†Ô∏è Debes iniciar la entrega antes de marcarla como entregada. Presiona "üöÄ Iniciar Entrega" primero.', 'warning');
                return;
            }
            
            if (!confirm('¬øConfirmas que el pedido fue entregado?')) return;

            // Deshabilitar botones temporalmente
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            try {
                // üÜï ACTUALIZAR UBICACI√ìN UNA √öLTIMA VEZ ANTES DE COMPLETAR
                console.log('üìç Actualizando ubicaci√≥n final antes de completar...');
                try {
                    if (isLocationActive) {
                        await updateLocation();
                        console.log('‚úÖ Ubicaci√≥n final actualizada');
                    } else {
                        console.warn('‚ö†Ô∏è Ubicaci√≥n no estaba activa, no se pudo actualizar ubicaci√≥n final');
                    }
                } catch (locError) {
                    console.warn('‚ö†Ô∏è Error al actualizar ubicaci√≥n final (no cr√≠tico):', locError);
                    // No detenemos el proceso por este error
                }

                const deliveryTime = Date.now();
                console.log('   - Tiempo de entrega:', new Date(deliveryTime).toLocaleTimeString());
                
                const { data: updatedOrder, error } = await supabase
                    .from('pedidos')
                    .update({
                        estado: 'entregado',
                        tiempo_entrega: deliveryTime,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', orderId)
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Error de Supabase:', error);
                    throw error;
                }
                
                console.log('‚úÖ Pedido marcado como entregado:', updatedOrder);

                // Actualizar estado del domiciliario a disponible
                console.log('üìù Actualizando estado del domiciliario a disponible...');
                console.log('   - Domiciliario ID:', currentDelivery.id);

                const { data: deliveryData, error: deliveryError } = await supabase
                    .from('domiciliarios')
                    .update({
                        estado: 'disponible',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentDelivery.id)
                    .select();

                if (deliveryError) {
                    console.error('‚ùå Error al actualizar estado del domiciliario:', deliveryError);
                    throw new Error('No se pudo actualizar el estado del domiciliario: ' + deliveryError.message);
                }

                console.log('‚úÖ Estado del domiciliario actualizado a disponible:', deliveryData);

                stopTimer();
                stopLocationTracking();
                
                showAlert('‚úÖ ¬°Pedido completado exitosamente! üéâ', 'success');
                
                console.log('üîÑ Recargando pedidos...');
                await loadOrders();
                console.log('‚úÖ ========== ENTREGA COMPLETADA EXITOSAMENTE ==========');
                
            } catch (error) {
                console.error('‚ùå ========== ERROR AL COMPLETAR ENTREGA ==========');
                console.error('Error completo:', error);
                showAlert('‚ùå Error al completar pedido: ' + error.message, 'danger');
            } finally {
                // Rehabilitar botones
                buttons.forEach(btn => btn.disabled = false);
            }
        };

        window.cancelOrder = async function(orderId) {
            console.log('‚ùå ========== CANCELANDO PEDIDO ==========');
            console.log('   - Pedido ID:', orderId);
            
            if (!confirm('¬øEst√°s seguro de cancelar este pedido?\n\nEsta acci√≥n no se puede deshacer.')) return;

            // Deshabilitar botones temporalmente
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            try {
                // Actualizar el pedido a estado cancelado
                const { data: updatedOrder, error } = await supabase
                    .from('pedidos')
                    .update({
                        estado: 'cancelado',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', orderId)
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Error de Supabase:', error);
                    throw error;
                }
                
                console.log('‚úÖ Pedido cancelado:', updatedOrder);

                // Actualizar estado del domiciliario a disponible
                console.log('üìù Actualizando estado del domiciliario a disponible...');
                console.log('   - Domiciliario ID:', currentDelivery.id);

                const { data: deliveryData, error: deliveryError } = await supabase
                    .from('domiciliarios')
                    .update({
                        estado: 'disponible',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentDelivery.id)
                    .select();

                if (deliveryError) {
                    console.error('‚ùå Error al actualizar estado del domiciliario:', deliveryError);
                    throw new Error('No se pudo actualizar el estado del domiciliario: ' + deliveryError.message);
                }

                console.log('‚úÖ Estado del domiciliario actualizado a disponible:', deliveryData);

                // Detener el temporizador si estaba activo
                stopTimer();
                
                // üî¥ CR√çTICO: Detener el tracking de ubicaci√≥n
                stopLocationTracking();
                
                showAlert('‚ùå Pedido cancelado', 'info');
                
                console.log('üîÑ Recargando pedidos...');
                await loadOrders();
                console.log('‚úÖ ========== PEDIDO CANCELADO EXITOSAMENTE ==========');
                
            } catch (error) {
                console.error('‚ùå ========== ERROR AL CANCELAR PEDIDO ==========');
                console.error('Error completo:', error);
                showAlert('‚ùå Error al cancelar pedido: ' + error.message, 'danger');
            } finally {
                // Rehabilitar botones
                buttons.forEach(btn => btn.disabled = false);
            }
        };

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('login-phone').value;
            await login(phone);
        });

        document.getElementById('login-phone').addEventListener('input', function() {
            this.classList.remove('error');
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('¬øSeguro que deseas cerrar sesi√≥n?')) {
                localStorage.removeItem('fluxi_delivery');
                stopLocationTracking();
                stopTimer();
                if (realtimeChannel) {
                    supabase.removeChannel(realtimeChannel);
                }
                location.reload();
            }
        });

        window.addEventListener('load', async () => {
            // Agregar badge de versi√≥n en la UI
            setTimeout(() => {
                const versionBadge = document.createElement('div');
                versionBadge.style.cssText = `
                    position: fixed;
                    bottom: 10px;
                    right: 10px;
                    background: rgba(102, 126, 234, 0.9);
                    color: white;
                    padding: 5px 12px;
                    border-radius: 15px;
                    font-size: 11px;
                    font-weight: bold;
                    z-index: 1000;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    cursor: pointer;
                `;
                versionBadge.textContent = `v${APP_VERSION}`;
                versionBadge.title = 'Toca para ver informaci√≥n';
                versionBadge.onclick = () => {
                    showAlert(`Fluxi Domiciliario v${APP_VERSION}\n\n√öltima actualizaci√≥n: 24-Oct-2024\n\nMejoras v2.2.0:\n‚Ä¢ Tracking en segundo plano\n‚Ä¢ Control manual de ubicaci√≥n\n‚Ä¢ Ubicaci√≥n al completar entregas`, 'info');
                };
                document.body.appendChild(versionBadge);
            }, 1000);
            
            const saved = localStorage.getItem('fluxi_delivery');
            if (saved) {
                currentDelivery = JSON.parse(saved);
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('delivery-name').textContent = currentDelivery.nombre;
                
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                
                setupRealtimeSubscription();
                
                await loadOrders();
                setInterval(loadOrders, 30000);
            }
        });
    </script>
</body>
</html>
