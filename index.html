<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxi - Sistema de Domicilios</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 1.2em;
            color: #ecf0f1;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #34495e;
            border-left-color: #3498db;
        }

        .menu-item.active {
            background: #34495e;
            border-left-color: #3498db;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
        }

        .module-container {
            display: none;
        }

        .module-container.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .card-header h3 {
            color: #2c3e50;
            font-size: 1.5em;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            margin: 0 2px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .input-with-prefix {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-prefix {
            position: absolute;
            left: 12px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
            pointer-events: none;
            z-index: 1;
        }

        .input-with-prefix input {
            padding-left: 30px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background: #ecf0f1;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .actions-cell {
            white-space: nowrap;
        }

        .actions-cell button, .actions-cell select {
            margin: 2px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h3 {
            color: #2c3e50;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .status-asignado {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-en_camino {
            background: #cce5ff;
            color: #004085;
        }

        .status-entregado {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelado {
            background: #f8d7da;
            color: #721c24;
        }

        #map, #tracking-map {
            background: #e0e0e0;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-dot.disponible {
            background: #27ae60;
        }

        .status-dot.ocupado {
            background: #f39c12;
        }

        .status-dot.inactivo {
            background: #e74c3c;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            #map, #tracking-map {
                height: 300px !important;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>üöÄ Fluxi</h2>
        </div>
        <div class="menu-item active" data-module="usuarios">üë• Gesti√≥n de Usuarios</div>
        <div class="menu-item" data-module="domiciliarios">üèçÔ∏è Domiciliarios</div>
        <div class="menu-item" data-module="pedidos">üì¶ Pedidos</div>
        <div class="menu-item" data-module="consulta">üîç Consulta de Pedidos</div>
        <div class="menu-item" data-module="dashboard">üìä Reportes</div>
        <div class="menu-item" data-module="cuadre-caja">üí∞ Cuadre de Caja</div>
        <div class="menu-item" data-module="configuracion">‚öôÔ∏è Configuraci√≥n</div>
    </div>

    <div class="main-content">
        <!-- USUARIOS -->
        <div id="module-usuarios" class="module-container active">
            <div class="card">
                <div class="card-header">
                    <h3>üë• Gesti√≥n de Usuarios</h3>
                    <button class="btn btn-primary" id="btn-new-user">+ Nuevo Usuario</button>
                </div>
                <div id="users-alert"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px;">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DOMICILIARIOS -->
        <div id="module-domiciliarios" class="module-container">
            <div class="card">
                <div class="card-header">
                    <h3>üèçÔ∏è Gesti√≥n de Domiciliarios</h3>
                    <button class="btn btn-primary" id="btn-new-delivery">+ Nuevo Domiciliario</button>
                </div>
                <div id="delivery-alert"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tel√©fono</th>
                                <th>Estado</th>
                                <th>√öltima Ubicaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="delivery-table-body">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px;">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>üó∫ Ubicaci√≥n en Tiempo Real</h3>
                    <button class="btn btn-secondary btn-small" id="btn-refresh-map">üîÑ Actualizar Mapa</button>
                </div>
                <div class="alert alert-info" style="margin-bottom: 15px;">
                    üìç <strong>Actualizaci√≥n autom√°tica:</strong> Las ubicaciones se actualizan cada minuto autom√°ticamente
                    <span id="map-last-update" style="display: block; margin-top: 5px; font-size: 12px;"></span>
                </div>
                <div id="map" style="height: 500px; border-radius: 8px;"></div>
            </div>

            <!-- Subm√≥dulo: Gesti√≥n de Domiciliarios del D√≠a -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>üìÖ Gesti√≥n de Domiciliarios del D√≠a</h3>
                    <button class="btn btn-success" id="btn-save-daily-config">üíæ Guardar Configuraci√≥n</button>
                </div>
                <div id="daily-config-alert"></div>
                <div class="alert alert-info" style="margin-bottom: 15px;">
                    ‚ÑπÔ∏è <strong>Selecciona los domiciliarios que trabajar√°n hoy</strong> y asigna el valor de arranque para cada uno. Solo los domiciliarios seleccionados estar√°n disponibles en la gesti√≥n de pedidos.
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 80px; text-align: center;">Activo Hoy</th>
                                <th style="width: 250px; text-align: center;">Domiciliario</th>
                                <th style="width: 150px; text-align: center;">Tel√©fono</th>
                                <th style="width: 150px; text-align: center;">Estado</th>
                                <th style="width: 200px; text-align: center;">Valor Arranque ($)</th>
                            </tr>
                        </thead>
                        <tbody id="daily-config-table-body">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px;">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PEDIDOS -->
        <div id="module-pedidos" class="module-container">
            <div class="card">
                <div class="card-header">
                    <h3>üì¶ Gesti√≥n de Pedidos</h3>
                    <button class="btn btn-primary" id="btn-new-order">+ Nuevo Pedido</button>
                </div>
                <div id="orders-alert"></div>

                <!-- Indicador de Fecha del D√≠a -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            padding: 15px 20px;
                            border-radius: 10px;
                            margin-bottom: 20px;
                            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">üìÖ</span>
                            <div>
                                <div style="color: white; font-size: 14px; font-weight: 600; margin-bottom: 3px;">
                                    Pedidos del D√≠a
                                </div>
                                <div id="orders-date-display" style="color: rgba(255, 255, 255, 0.95); font-size: 18px; font-weight: 700;">
                                    Cargando...
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="background: rgba(255, 255, 255, 0.2);
                                        padding: 8px 15px;
                                        border-radius: 8px;
                                        backdrop-filter: blur(10px);">
                                <div style="color: rgba(255, 255, 255, 0.9); font-size: 11px; margin-bottom: 2px;">
                                    Reinicio a las
                                </div>
                                <div id="orders-reset-time-display" style="color: white; font-size: 15px; font-weight: 700;">
                                    08:00 AM
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filter-status" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="asignado">Asignado</option>
                        <option value="en_camino">En camino</option>
                        <option value="entregado">Entregado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                    <button class="btn btn-secondary btn-small" id="btn-refresh-orders">üîÑ Actualizar</button>
                </div>
                <div class="table-container">
                    <table style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th style="width: 60px; text-align: center; font-size: 12px;">ID</th>
                                <th style="width: 110px; text-align: center; font-size: 12px;">Cliente</th>
                                <th style="width: 140px; text-align: center; font-size: 12px;">Direcci√≥n</th>
                                <th style="width: 90px; text-align: center; font-size: 12px;">Barrio</th>
                                <th style="width: 75px; text-align: center; font-size: 12px;">Total</th>
                                <th style="width: 90px; text-align: center; font-size: 12px;">Tipo Dom.</th>
                                <th style="width: 120px; text-align: center; font-size: 12px;">Domiciliario</th>
                                <th style="width: 85px; text-align: center; font-size: 12px;">M. Pago</th>
                                <th style="width: 75px; text-align: center; font-size: 12px;">Datafono</th>
                                <th style="width: 95px; text-align: center; font-size: 12px;">E. Voucher</th>
                                <th style="width: 85px; text-align: center; font-size: 12px;">Estado</th>
                                <th style="width: 70px; text-align: center; font-size: 12px;">Tiempo</th>
                                <th style="width: 115px; text-align: center; font-size: 12px;">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr>
                                <td colspan="13" style="text-align: center; padding: 30px;">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CONSULTA DE PEDIDOS -->
        <div id="module-consulta" class="module-container">
            <div class="card">
                <div class="card-header">
                    <h3>üîç Consulta de Pedidos</h3>
                </div>
                <div id="search-alert"></div>

                <!-- Panel de b√∫squeda -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">Criterios de B√∫squeda</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">ID</label>
                            <input type="text" id="search-id" placeholder="Ej: abc123..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Cliente</label>
                            <input type="text" id="search-cliente" placeholder="Nombre del cliente" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Direcci√≥n</label>
                            <input type="text" id="search-direccion" placeholder="Direcci√≥n" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Barrio</label>
                            <input type="text" id="search-barrio" placeholder="Barrio" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tipo Domiciliario</label>
                            <select id="search-tipo-dom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Todos</option>
                                <option value="propio">Propio</option>
                                <option value="rappi">Rappi</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Domiciliario</label>
                            <select id="search-domiciliario" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">M√©todo Pago</label>
                            <select id="search-metodo-pago" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Todos</option>
                                <option value="efectivo">Efectivo</option>
                                <option value="tarjeta">Tarjeta</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Datafono</label>
                            <input type="text" id="search-datafono" placeholder="N√∫mero" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Estado Voucher</label>
                            <select id="search-estado-voucher" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Todos</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="entregado">Entregado</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Estado</label>
                            <select id="search-estado" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Todos</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="asignado">Asignado</option>
                                <option value="en_camino">En camino</option>
                                <option value="entregado">Entregado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Fecha Desde</label>
                            <input type="date" id="search-fecha-desde" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Fecha Hasta</label>
                            <input type="date" id="search-fecha-hasta" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="btn-search-orders">üîç Buscar</button>
                        <button class="btn btn-secondary" id="btn-clear-search">üóëÔ∏è Limpiar</button>
                    </div>
                </div>

                <!-- Tabla de resultados -->
                <div class="table-container">
                    <table style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th style="width: 60px; text-align: center; font-size: 12px;">ID</th>
                                <th style="width: 110px; text-align: center; font-size: 12px;">Cliente</th>
                                <th style="width: 140px; text-align: center; font-size: 12px;">Direcci√≥n</th>
                                <th style="width: 90px; text-align: center; font-size: 12px;">Barrio</th>
                                <th style="width: 75px; text-align: center; font-size: 12px;">Total</th>
                                <th style="width: 90px; text-align: center; font-size: 12px;">Tipo Dom.</th>
                                <th style="width: 120px; text-align: center; font-size: 12px;">Domiciliario</th>
                                <th style="width: 85px; text-align: center; font-size: 12px;">M. Pago</th>
                                <th style="width: 75px; text-align: center; font-size: 12px;">Datafono</th>
                                <th style="width: 95px; text-align: center; font-size: 12px;">E. Voucher</th>
                                <th style="width: 85px; text-align: center; font-size: 12px;">Estado</th>
                                <th style="width: 100px; text-align: center; font-size: 12px;">Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="search-results-table">
                            <tr>
                                <td colspan="12" style="text-align: center; padding: 30px;">Utiliza los filtros de b√∫squeda para encontrar pedidos</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- REPORTES -->
        <div id="module-dashboard" class="module-container">
            <!-- Panel de Filtros -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h3>üìä Filtros de Reportes</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Fecha Desde</label>
                        <input type="date" id="filter-date-from" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Fecha Hasta</label>
                        <input type="date" id="filter-date-to" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Tipo de Domiciliario</label>
                        <select id="filter-delivery-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <option value="">Todos</option>
                            <option value="propio">Domiciliario Propio</option>
                            <option value="rappi">Rappi</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Domiciliario</label>
                        <select id="filter-delivery-person" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Datafono</label>
                        <select id="filter-dataphone" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>M√©todo de Pago</label>
                        <select id="filter-payment-method" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <option value="">Todos</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="tarjeta">Tarjeta</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Estado Voucher</label>
                        <select id="filter-voucher-status" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <option value="">Todos</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="entregado">Entregado</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Estado Pedido</label>
                        <select id="filter-order-status" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <option value="">Todos</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="asignado">Asignado</option>
                            <option value="en_camino">En Camino</option>
                            <option value="entregado">Entregado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="btn-apply-filters">üîç Aplicar Filtros</button>
                    <button class="btn btn-secondary" id="btn-clear-filters">üóëÔ∏è Limpiar Filtros</button>
                </div>
            </div>

            <!-- M√©tricas Principales -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total de Pedidos</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-total-orders">0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üì¶</div>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Ingresos por Pedido</div>
                            <div style="font-size: 28px; font-weight: bold;" id="stat-order-income">$0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üíµ</div>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Ingresos por Domicilio</div>
                            <div style="font-size: 28px; font-weight: bold;" id="stat-delivery-income">$0</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">üèçÔ∏è</div>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Tiempo Promedio</div>
                            <div style="font-size: 32px; font-weight: bold;" id="stat-avg-time">--</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.3;">‚è±Ô∏è</div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del Rango Seleccionado -->
            <div class="card" style="background: #e3f2fd; margin-bottom: 20px;">
                <div style="text-align: center; color: #1976d2; font-weight: 500;">
                    üìÖ <span id="date-range-display">Mostrando todos los pedidos</span>
                </div>
            </div>

            <!-- Gr√°ficos -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                <div class="card">
                    <div class="card-header">
                        <h3>üìä Estado de Pedidos</h3>
                    </div>
                    <canvas id="status-chart" style="max-height: 300px;"></canvas>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>üí∞ Distribuci√≥n de Ingresos</h3>
                    </div>
                    <canvas id="income-distribution-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Tabla de Pedidos Filtrados -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>üì¶ Pedidos del Periodo Seleccionado</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Valor Pedido</th>
                                <th>Valor Domicilio</th>
                                <th>Total</th>
                                <th>Domiciliario</th>
                                <th>Datafono</th>
                                <th>M√©todo Pago</th>
                                <th>Estado</th>
                                <th>Tiempo</th>
                            </tr>
                        </thead>
                        <tbody id="filtered-orders-table">
                            <tr>
                                <td colspan="11" style="text-align: center; padding: 30px;">Aplica filtros para ver pedidos</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gr√°fico de Ingresos por D√≠a -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>üìà Ingresos por D√≠a</h3>
                </div>
                <canvas id="income-chart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- CUADRE DE CAJA -->
        <div id="module-cuadre-caja" class="module-container">
            <div class="card">
                <div class="card-header">
                    <h3>üí∞ Cuadre de Caja</h3>
                </div>
                <div id="cuadre-alert"></div>

                <!-- Panel de Filtros -->
                <div class="card" style="background: #f8f9fa; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">üîç Filtros de Consulta</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Fecha de Consulta</label>
                            <input type="date" id="cuadre-fecha" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Selecciona la fecha para ver el cuadre
                            </small>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Domiciliario</label>
                            <select id="cuadre-domiciliario" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                                <option value="">Todos los Domiciliarios</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="btn-calcular-cuadre">üí∞ Calcular Cuadre</button>
                        <button class="btn btn-secondary" id="btn-limpiar-cuadre">üóëÔ∏è Limpiar</button>
                    </div>
                </div>

                <!-- Resumen General -->
                <div id="cuadre-summary" style="display: none; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">üìä Resumen del D√≠a</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <!-- Card Efectivo -->
                        <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 12px;
                                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                    transition: transform 0.2s;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div style="font-size: 14px; opacity: 0.9; font-weight: 500;">üíµ Total en Efectivo</div>
                            </div>
                            <div id="cuadre-total-efectivo" style="font-size: 28px; font-weight: bold;">$0</div>
                            <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">Arranque + Recaudado</div>
                        </div>

                        <!-- Card Tarjetas -->
                        <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 12px;
                                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                    transition: transform 0.2s;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div style="font-size: 14px; opacity: 0.9; font-weight: 500;">üí≥ Total en Tarjetas</div>
                            </div>
                            <div id="cuadre-total-tarjetas" style="font-size: 28px; font-weight: bold;">$0</div>
                            <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">Pagos con dat√°fono</div>
                        </div>

                        <!-- Card Total General -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    padding: 20px;
                                    border-radius: 12px;
                                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                    transition: transform 0.2s;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div style="font-size: 14px; opacity: 0.9; font-weight: 500;">üí∞ Total General</div>
                            </div>
                            <div id="cuadre-total-general" style="font-size: 32px; font-weight: bold;">$0</div>
                            <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">Efectivo + Tarjetas</div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Cuadre por Domiciliario -->
                <div class="table-container" id="cuadre-table-container" style="display: none;">
                    <table style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th style="text-align: center; font-size: 12px;">Domiciliario</th>
                                <th style="text-align: center; font-size: 12px;">Valor Arranque</th>
                                <th style="text-align: center; font-size: 12px;">Efectivo Pedidos</th>
                                <th style="text-align: center; font-size: 12px;">Total Efectivo</th>
                                <th style="text-align: center; font-size: 12px;">Tarjetas (por Datafono)</th>
                                <th style="text-align: center; font-size: 12px;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="cuadre-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px;">
                                    Selecciona una fecha y haz clic en "Calcular Cuadre"
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Mensaje inicial -->
                <div id="cuadre-initial-message" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üí∞</div>
                    <h4 style="color: #666; margin-bottom: 10px;">Cuadre de Caja de Domiciliarios</h4>
                    <p>Selecciona una fecha y opcionalmente un domiciliario para ver el cuadre de caja.</p>
                    <p style="font-size: 14px; color: #999;">
                        Se mostrar√°: Valor de arranque + Efectivo recaudado + Tarjetas por datafono
                    </p>
                </div>
            </div>
        </div>

        <!-- CONFIGURACI√ìN -->
        <div id="module-configuracion" class="module-container">
            <div class="card">
                <div class="card-header">
                    <h3>‚öôÔ∏è Configuraci√≥n de Fluxi</h3>
                </div>
                <div class="alert alert-success">
                    <strong>‚úÖ Fluxi est√° correctamente configurado</strong><br>
                    Tu aplicaci√≥n est√° lista para usar con GitHub Pages.
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">üì± App para Domiciliarios</h4>
                    <div class="alert alert-info">
                        <strong>üèçÔ∏è URL de la App:</strong><br>
                        Los domiciliarios recibir√°n autom√°ticamente el link por WhatsApp cuando se les asigne un pedido.<br><br>
                        <strong>Link:</strong> <code id="app-url-display">Cargando...</code>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">‚è∞ Hora de Reinicio Diario</h4>
                    <div id="config-alert"></div>
                    <p style="margin-bottom: 15px; color: #666;">
                        Configura la hora a partir de la cual la tabla de gesti√≥n de pedidos mostrar√° solo los pedidos nuevos del d√≠a.
                        Los pedidos anteriores a esta hora no se mostrar√°n en la tabla.
                    </p>
                    <div style="display: flex; gap: 15px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label>Hora de Reinicio (Hora Colombia) *</label>
                            <input type="time" id="config-reset-time" value="08:00" required
                                   style="padding: 10px; font-size: 16px;">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Ejemplo: 08:00 para las 8:00 AM
                            </small>
                        </div>
                        <button type="button" class="btn btn-success" id="btn-save-reset-time"
                                style="padding: 12px 24px;">
                            üíæ Guardar Configuraci√≥n
                        </button>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">üìã Instrucciones</h4>
                    <ol style="line-height: 2;">
                        <li>Crea domiciliarios en el m√≥dulo correspondiente</li>
                        <li>Crea un nuevo pedido y asigna un domiciliario</li>
                        <li>Se abrir√° WhatsApp autom√°ticamente con el mensaje y link</li>
                        <li>El domiciliario abre el link y gestiona su pedido</li>
                        <li>El sistema actualiza todo en tiempo real</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Usuario -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="user-modal-title">Nuevo Usuario</h3>
            </div>
            <form id="user-form">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="user-name" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="user-email" required>
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" id="user-phone" value="+57" placeholder="+573001234567">
                </div>
                <div class="form-group">
                    <label>Rol *</label>
                    <select id="user-role" required>
                        <option value="">Seleccionar...</option>
                        <option value="administrador">Administrador</option>
                        <option value="visualizador">Visualizador</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado *</label>
                    <select id="user-status" required>
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btn-cancel-user">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Domiciliario -->
    <div id="delivery-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="delivery-modal-title">Nuevo Domiciliario</h3>
            </div>
            <form id="delivery-form">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="delivery-name" required placeholder="Ej: Juan P√©rez">
                </div>
                <div class="form-group">
                    <label>N√∫mero de Tel√©fono *</label>
                    <input type="tel" id="delivery-phone" required value="+57" placeholder="+573001234567">
                    <small style="color: #7f8c8d; font-size: 12px;">Formato: +57 seguido del n√∫mero</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btn-cancel-delivery">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Pedido -->
    <div id="order-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="order-modal-title">Nuevo Pedido</h3>
            </div>
            <form id="order-form">
                <div class="form-group">
                    <label>Nombre del Cliente *</label>
                    <input type="text" id="order-customer-name" required placeholder="Ej: Mar√≠a Rodr√≠guez">
                </div>
                <div class="form-group">
                    <label>Tel√©fono del Cliente *</label>
                    <input type="tel" id="order-customer-phone" required value="+57" placeholder="+573001234567">
                </div>
                <div class="form-group">
                    <label>Direcci√≥n de Entrega *</label>
                    <textarea id="order-address" required rows="2" placeholder="Ej: Calle 123 #45-67, Apto 501"></textarea>
                </div>
                <div class="form-group">
                    <label>Barrio *</label>
                    <input type="text" id="order-neighborhood" required placeholder="Ej: Centro, Chapinero, etc.">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Valor del Pedido *</label>
                        <div class="input-with-prefix">
                            <span class="input-prefix">$</span>
                            <input type="text" id="order-value" required placeholder="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Valor del Domicilio *</label>
                        <div class="input-with-prefix">
                            <span class="input-prefix">$</span>
                            <input type="text" id="order-delivery-fee" required placeholder="0">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Total a Cobrar</label>
                    <input type="text" id="order-total" readonly style="background: #ecf0f1; font-weight: bold; font-size: 18px;">
                </div>
                <div class="form-group">
                    <label>M√©todo de Pago *</label>
                    <select id="order-payment-method" required>
                        <option value="">Seleccionar...</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="tarjeta">Tarjeta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notas Adicionales</label>
                    <textarea id="order-notes" rows="2" placeholder="Ej: Tocar el timbre 3 veces"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btn-cancel-order">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tracking -->
    <div id="tracking-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>üó∫ Seguimiento del Pedido</h3>
                <button type="button" class="btn btn-info btn-small" id="btn-refresh-tracking" style="margin-left: auto;">
                    üîÑ Actualizar
                </button>
            </div>
            <div id="tracking-info" style="margin-bottom: 20px;"></div>
            <div id="tracking-map" style="height: 400px; border-radius: 8px; margin-bottom: 15px;"></div>
            <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                <div><strong>Estado:</strong> <span id="tracking-status" class="status-badge">--</span></div>
                <div><strong>Tiempo transcurrido:</strong> <span id="tracking-time">--</span></div>
            </div>
            <div id="tracking-last-update" style="text-align: center; font-size: 12px; color: #666; margin-bottom: 15px;">
                üïí √öltima actualizaci√≥n: <span id="tracking-update-time">--</span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btn-close-tracking">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const SUPABASE_URL = 'https://lbifbexhmvbanvrjfglp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxiaWZiZXhobXZiYW52cmpmZ2xwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5Mjg5MDQsImV4cCI6MjA3NjUwNDkwNH0.ZXjCv4DkNobkn3IDK9wYBjjOV55Bf_UwcSxhkt6YqGo';
        
        // Detectar autom√°ticamente la URL de la app
        const APP_URL = window.location.origin + window.location.pathname.replace('index.html', '') + 'app-domiciliarios.html';
        
        // Mostrar URL en configuraci√≥n
        setTimeout(() => {
            const urlDisplay = document.getElementById('app-url-display');
            if (urlDisplay) {
                urlDisplay.textContent = APP_URL;
            }
        }, 1000);

        let supabase = null;
        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            // Exponer supabase globalmente para acceso desde consola y depuraci√≥n
            window.supabase = supabase;
            window.supabaseClient = supabase; // Alias adicional
            console.log('%c‚úÖ Fluxi conectado', 'color: green; font-weight: bold;');
            console.log('%cüì° Supabase URL:', 'color: blue;', SUPABASE_URL);
        } catch (error) {
            console.error('Error al conectar con Supabase:', error);
        }

        let currentUserId = null;
        let currentDeliveryId = null;
        let currentOrderId = null;
        let currentTrackingOrder = null; // Para mantener el pedido que se est√° rastreando
        let allOrders = [];
        let allDeliveryDrivers = []; // Domiciliarios disponibles
        let dailyDriversConfig = []; // Configuraci√≥n de domiciliarios del d√≠a
        let map = null;
        let markers = {};
        let trackingMap = null;
        let trackingMarker = null;
        let statusChart = null;
        let incomeChart = null;
        let incomeDistributionChart = null;
        let mapUpdateInterval = null;
        let trackingUpdateInterval = null;
        let locationSubscription = null;

        function formatNumberWithDots(value) {
            return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function parseFormattedNumber(value) {
            return parseInt(value.replace(/\./g, '')) || 0;
        }

        function formatCurrencyInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value) {
                input.value = formatNumberWithDots(value);
            } else {
                input.value = '';
            }
            calculateTotal();
        }

        function showAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
            container.innerHTML = '<div class="alert ' + alertClass + '">' + message + '</div>';
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value);
        }

        function calculateElapsedTime(timestamp) {
            if (!timestamp) return '--';
            const now = Date.now();
            const diff = now - timestamp;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            return hours > 0 ? hours + 'h ' + minutes + 'm' : minutes + 'm';
        }

        function sendWhatsAppNotification(phone, nombre, consecutivo) {
            const cleanPhone = phone.replace(/\D/g, '');
            const msg = `¬°Hola ${nombre}! üèçÔ∏è\n\n` +
                       `Tienes un nuevo pedido asignado en Fluxi.\n\n` +
                       `üì¶ Pedido #${consecutivo}\n\n` +
                       `üì± Abre tu app para aceptar el pedido:\n` +
                       `${APP_URL}\n\n` +
                       `Recuerda que debes activar tu ubicaci√≥n para poder iniciar la entrega.\n\n` +
                       `¬°Gracias!`;

            window.open('https://wa.me/' + cleanPhone + '?text=' + encodeURIComponent(msg), '_blank');
        }

        // Navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                // Limpiar intervalos previos
                if (mapUpdateInterval) {
                    clearInterval(mapUpdateInterval);
                    mapUpdateInterval = null;
                }
                if (trackingUpdateInterval) {
                    clearInterval(trackingUpdateInterval);
                    trackingUpdateInterval = null;
                }
                if (ordersAutoReloadInterval) {
                    clearTimeout(ordersAutoReloadInterval);
                    ordersAutoReloadInterval = null;
                }

                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                document.querySelectorAll('.module-container').forEach(m => m.classList.remove('active'));
                this.classList.add('active');
                const moduleName = this.dataset.module;
                document.getElementById('module-' + moduleName).classList.add('active');
                
                // Guardar m√≥dulo activo en localStorage
                localStorage.setItem('fluxi_active_module', moduleName);
                
                if (moduleName === 'domiciliarios') {
                    setTimeout(() => {
                        initMap();
                        loadDeliveries();
                        loadDailyDriversConfig();
                        // Actualizar mapa cada 1 minuto
                        mapUpdateInterval = setInterval(() => {
                            loadDeliveries();
                        }, 60000);
                    }, 100);
                } else if (moduleName === 'pedidos') {
                    setTimeout(() => loadOrders(), 100);
                } else if (moduleName === 'dashboard') {
                    setTimeout(() => {
                        loadDashboardFilters();
                        loadDashboard();
                    }, 100);
                } else if (moduleName === 'consulta') {
                    setTimeout(() => loadSearchFilters(), 100);
                } else if (moduleName === 'cuadre-caja') {
                    setTimeout(() => loadCuadreFilters(), 100);
                } else if (moduleName === 'configuracion') {
                    setTimeout(() => loadGeneralConfig(), 100);
                }
            });
        });

        // ========== USUARIOS ==========
        async function loadUsers() {
            if (!supabase) return;
            try {
                const result = await supabase.from('usuarios').select('*').order('created_at', { ascending: false });
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';
                
                if (!result.data || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No hay usuarios</td></tr>';
                    return;
                }
                
                result.data.forEach(user => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td><strong>${user.nombre}</strong></td><td>${user.email}</td><td></td><td></td><td class="actions-cell"></td>`;
                    
                    const roleBadge = document.createElement('span');
                    roleBadge.className = 'badge ' + (user.rol === 'administrador' ? 'badge-danger' : 'badge-info');
                    roleBadge.textContent = user.rol === 'administrador' ? 'Administrador' : 'Visualizador';
                    row.cells[2].appendChild(roleBadge);
                    
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'badge ' + (user.estado === 'activo' ? 'badge-success' : 'badge-danger');
                    statusBadge.textContent = user.estado === 'activo' ? 'Activo' : 'Inactivo';
                    row.cells[3].appendChild(statusBadge);
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-primary btn-small';
                    editBtn.textContent = 'Editar';
                    editBtn.onclick = () => openUserModal(user);
                    row.cells[4].appendChild(editBtn);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-small';
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.onclick = () => deleteUser(user.id);
                    row.cells[4].appendChild(deleteBtn);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function openUserModal(user) {
            currentUserId = user ? user.id : null;
            document.getElementById('user-modal-title').textContent = user ? 'Editar Usuario' : 'Nuevo Usuario';
            document.getElementById('user-name').value = user ? user.nombre : '';
            document.getElementById('user-email').value = user ? user.email : '';
            document.getElementById('user-phone').value = user && user.telefono ? user.telefono : '+57';
            document.getElementById('user-role').value = user ? user.rol : '';
            document.getElementById('user-status').value = user ? user.estado : 'activo';
            document.getElementById('user-modal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('user-modal').classList.remove('active');
            document.getElementById('user-form').reset();
            document.getElementById('user-phone').value = '+57';
            currentUserId = null;
        }

        async function deleteUser(id) {
            if (!confirm('¬øEliminar este usuario?')) return;
            try {
                await supabase.from('usuarios').delete().eq('id', id);
                showAlert('users-alert', 'success', 'Usuario eliminado');
                loadUsers();
            } catch (error) {
                showAlert('users-alert', 'error', 'Error: ' + error.message);
            }
        }

        document.getElementById('btn-new-user').addEventListener('click', () => openUserModal(null));
        document.getElementById('btn-cancel-user').addEventListener('click', closeUserModal);
        document.getElementById('user-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeUserModal(); });

        document.getElementById('user-form').addEventListener('submit', async e => {
            e.preventDefault();
            if (!supabase) return;
            
            let telefono = document.getElementById('user-phone').value.trim();
            if (telefono === '+57') telefono = '';
            
            const userData = {
                nombre: document.getElementById('user-name').value.trim(),
                email: document.getElementById('user-email').value.trim(),
                telefono,
                rol: document.getElementById('user-role').value,
                estado: document.getElementById('user-status').value,
                updated_at: new Date().toISOString()
            };
            
            try {
                if (currentUserId) {
                    await supabase.from('usuarios').update(userData).eq('id', currentUserId);
                    showAlert('users-alert', 'success', 'Usuario actualizado');
                } else {
                    userData.created_at = new Date().toISOString();
                    await supabase.from('usuarios').insert([userData]);
                    showAlert('users-alert', 'success', 'Usuario creado');
                }
                closeUserModal();
                loadUsers();
            } catch (error) {
                showAlert('users-alert', 'error', 'Error: ' + error.message);
            }
        });

        // ========== DOMICILIARIOS ==========
        function initMap() {
            if (map) return;
            map = L.map('map').setView([4.7110, -74.0721], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
        }

        async function loadDeliveries() {
            if (!supabase) return;
            try {
                const result = await supabase.from('domiciliarios').select('*').order('created_at', { ascending: false });
                const tbody = document.getElementById('delivery-table-body');
                tbody.innerHTML = '';
                
                // Actualizar indicador de √∫ltima actualizaci√≥n
                const updateIndicator = document.getElementById('map-last-update');
                if (updateIndicator) {
                    updateIndicator.textContent = 'üïí √öltima actualizaci√≥n: ' + new Date().toLocaleTimeString('es-CO');
                }
                
                if (!result.data || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No hay domiciliarios</td></tr>';
                    return;
                }
                
                result.data.forEach(delivery => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td><strong>${delivery.nombre}</strong></td><td>${delivery.telefono}</td><td></td><td></td><td class="actions-cell"></td>`;
                    
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'badge ' + (delivery.estado === 'disponible' ? 'badge-success' : delivery.estado === 'ocupado' ? 'badge-warning' : 'badge-danger');
                    statusBadge.textContent = delivery.estado.charAt(0).toUpperCase() + delivery.estado.slice(1);
                    row.cells[2].appendChild(statusBadge);
                    
                    const location = delivery.ubicacion ? new Date(delivery.ubicacion.timestamp).toLocaleString('es-CO') : 'Sin ubicaci√≥n';
                    row.cells[3].textContent = location;
                    row.cells[3].style.fontSize = '12px';
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-primary btn-small';
                    editBtn.textContent = 'Editar';
                    editBtn.onclick = () => openDeliveryModal(delivery);
                    row.cells[4].appendChild(editBtn);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-small';
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.onclick = () => deleteDelivery(delivery.id);
                    row.cells[4].appendChild(deleteBtn);
                    
                    if (delivery.ubicacion && delivery.ubicacion.lat && delivery.ubicacion.lng) {
                        updateMarker(delivery.id, delivery);
                    }
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateMarker(id, delivery) {
            if (!map) initMap();
            const lat = delivery.ubicacion.lat;
            const lng = delivery.ubicacion.lng;
            
            if (markers[id]) {
                markers[id].setLatLng([lat, lng]);
            } else {
                const color = delivery.estado === 'disponible' ? '#27ae60' : delivery.estado === 'ocupado' ? '#f39c12' : '#e74c3c';
                const iconDiv = document.createElement('div');
                iconDiv.style.cssText = `background:${color};width:30px;height:30px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:16px`;
                iconDiv.textContent = 'üèçÔ∏è';
                
                const icon = L.divIcon({ className: 'custom-marker', html: iconDiv.outerHTML, iconSize: [30, 30] });
                const marker = L.marker([lat, lng], { icon }).addTo(map);
                marker.bindPopup(`<strong>${delivery.nombre}</strong><br>${delivery.telefono}`);
                markers[id] = marker;
            }
        }

        function openDeliveryModal(delivery) {
            currentDeliveryId = delivery ? delivery.id : null;
            document.getElementById('delivery-modal-title').textContent = delivery ? 'Editar Domiciliario' : 'Nuevo Domiciliario';
            document.getElementById('delivery-name').value = delivery ? delivery.nombre : '';
            document.getElementById('delivery-phone').value = delivery ? delivery.telefono : '+57';
            document.getElementById('delivery-modal').classList.add('active');
        }

        function closeDeliveryModal() {
            document.getElementById('delivery-modal').classList.remove('active');
            document.getElementById('delivery-form').reset();
            document.getElementById('delivery-phone').value = '+57';
            currentDeliveryId = null;
        }

        async function deleteDelivery(id) {
            if (!confirm('¬øEliminar este domiciliario?')) return;
            try {
                await supabase.from('domiciliarios').delete().eq('id', id);
                if (markers[id]) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                }
                showAlert('delivery-alert', 'success', 'Domiciliario eliminado');
                loadDeliveries();
            } catch (error) {
                showAlert('delivery-alert', 'error', 'Error');
            }
        }

        // ========== GESTI√ìN DIARIA DE DOMICILIARIOS ==========
        async function loadDailyDriversConfig() {
            if (!supabase) return;
            try {
                // Cargar todos los domiciliarios
                const { data: drivers, error: driversError } = await supabase
                    .from('domiciliarios')
                    .select('*')
                    .order('nombre');

                if (driversError) throw driversError;

                // Cargar configuraci√≥n del d√≠a actual
                const today = new Date().toISOString().split('T')[0];
                const { data: config, error: configError } = await supabase
                    .from('configuracion_diaria')
                    .select('*')
                    .eq('fecha', today);

                if (configError) throw configError;

                dailyDriversConfig = config || [];

                renderDailyDriversConfig(drivers);
            } catch (error) {
                console.error('Error al cargar configuraci√≥n diaria:', error);
                showAlert('daily-config-alert', 'error', 'Error al cargar configuraci√≥n');
            }
        }

        function renderDailyDriversConfig(drivers) {
            const tbody = document.getElementById('daily-config-table-body');
            tbody.innerHTML = '';

            if (!drivers || drivers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No hay domiciliarios registrados</td></tr>';
                return;
            }

            drivers.forEach(driver => {
                const config = dailyDriversConfig.find(c => c.domiciliario_id === driver.id);
                const isActive = config ? true : false;
                const valorArranque = config ? config.valor_arranque : '';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox"
                               data-driver-id="${driver.id}"
                               class="daily-driver-checkbox"
                               ${isActive ? 'checked' : ''}
                               style="width: 20px; height: 20px; cursor: pointer;">
                    </td>
                    <td style="text-align: center;"><strong>${driver.nombre}</strong></td>
                    <td style="text-align: center;">${driver.telefono}</td>
                    <td style="text-align: center;">
                        <span class="badge ${driver.estado === 'disponible' ? 'badge-success' : driver.estado === 'ocupado' ? 'badge-warning' : 'badge-danger'}">
                            ${driver.estado.charAt(0).toUpperCase() + driver.estado.slice(1)}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <input type="text"
                               data-driver-id="${driver.id}"
                               class="daily-driver-value"
                               placeholder="0"
                               value="${valorArranque ? formatNumberWithDots(valorArranque) : ''}"
                               ${!isActive ? 'disabled' : ''}
                               style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; text-align: center;">
                    </td>
                `;

                // Event listener para habilitar/deshabilitar el input de valor
                const checkbox = row.querySelector('.daily-driver-checkbox');
                const valueInput = row.querySelector('.daily-driver-value');

                checkbox.addEventListener('change', () => {
                    valueInput.disabled = !checkbox.checked;
                    if (!checkbox.checked) {
                        valueInput.value = '';
                    }
                });

                // Formatear valor mientras se escribe
                valueInput.addEventListener('input', function() {
                    formatCurrencyInput(this);
                });
            });
        }

        async function saveDailyDriversConfig() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const checkboxes = document.querySelectorAll('.daily-driver-checkbox:checked');
                const configData = [];

                checkboxes.forEach(checkbox => {
                    const driverId = checkbox.dataset.driverId;
                    const valueInput = document.querySelector(`.daily-driver-value[data-driver-id="${driverId}"]`);
                    const valor = parseFormattedNumber(valueInput.value) || 0;

                    configData.push({
                        fecha: today,
                        domiciliario_id: driverId,
                        valor_arranque: valor,
                        created_at: new Date().toISOString()
                    });
                });

                // Eliminar configuraci√≥n anterior del d√≠a
                await supabase.from('configuracion_diaria').delete().eq('fecha', today);

                // Insertar nueva configuraci√≥n
                if (configData.length > 0) {
                    const { error } = await supabase.from('configuracion_diaria').insert(configData);
                    if (error) throw error;
                }

                showAlert('daily-config-alert', 'success', `Configuraci√≥n guardada: ${configData.length} domiciliario(s) activo(s)`);

                // Recargar configuraci√≥n
                await loadDailyDriversConfig();

                // Recargar pedidos para actualizar la lista de domiciliarios disponibles
                await loadOrders();
            } catch (error) {
                console.error('Error al guardar configuraci√≥n:', error);
                showAlert('daily-config-alert', 'error', 'Error al guardar configuraci√≥n');
            }
        }

        document.getElementById('btn-new-delivery').addEventListener('click', () => openDeliveryModal(null));
        document.getElementById('btn-cancel-delivery').addEventListener('click', closeDeliveryModal);
        document.getElementById('btn-refresh-map').addEventListener('click', loadDeliveries);
        document.getElementById('btn-save-daily-config').addEventListener('click', saveDailyDriversConfig);
        document.getElementById('delivery-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeDeliveryModal(); });

        document.getElementById('delivery-form').addEventListener('submit', async e => {
            e.preventDefault();
            const deliveryData = {
                nombre: document.getElementById('delivery-name').value,
                telefono: document.getElementById('delivery-phone').value,
                estado: 'disponible',
                updated_at: new Date().toISOString()
            };
            
            try {
                if (currentDeliveryId) {
                    const { data: current } = await supabase.from('domiciliarios').select('estado').eq('id', currentDeliveryId).single();
                    deliveryData.estado = current.estado;
                    await supabase.from('domiciliarios').update(deliveryData).eq('id', currentDeliveryId);
                    showAlert('delivery-alert', 'success', 'Domiciliario actualizado');
                } else {
                    deliveryData.created_at = new Date().toISOString();
                    await supabase.from('domiciliarios').insert([deliveryData]);
                    showAlert('delivery-alert', 'success', 'Domiciliario creado');
                }
                closeDeliveryModal();
                loadDeliveries();
            } catch (error) {
                console.error('Error al guardar domiciliario:', error);
                showAlert('delivery-alert', 'error', 'Error: ' + error.message);
            }
        });

        // ========== PEDIDOS ==========
        let ordersAutoReloadInterval = null;

        async function loadOrders() {
            if (!supabase) return;
            try {
                // Obtener timestamp de reinicio del d√≠a
                const resetTimestamp = await getTodayResetTimestamp();

                // Cargar pedidos desde la hora de reinicio
                let query = supabase.from('pedidos').select('*');

                if (resetTimestamp) {
                    query = query.gte('created_at', resetTimestamp);
                }

                const result = await query.order('created_at', { ascending: false });
                allOrders = result.data || [];

                console.log(`üì¶ Pedidos cargados desde ${resetTimestamp ? new Date(resetTimestamp).toLocaleString('es-CO', { timeZone: 'America/Bogota' }) : 'siempre'}: ${allOrders.length} pedido(s)`);

                // Actualizar indicador de fecha
                await updateOrdersDateDisplay();

                // Cargar configuraci√≥n del d√≠a para filtrar domiciliarios activos
                const today = new Date().toISOString().split('T')[0];
                const { data: dailyConfig } = await supabase
                    .from('configuracion_diaria')
                    .select('domiciliario_id')
                    .eq('fecha', today);

                const activeDriverIds = dailyConfig ? dailyConfig.map(c => c.domiciliario_id) : [];

                // Cargar solo domiciliarios activos del d√≠a, ordenados alfab√©ticamente
                const deliveriesResult = await supabase.from('domiciliarios').select('*').order('nombre');

                // Filtrar solo los domiciliarios activos del d√≠a
                if (activeDriverIds.length > 0) {
                    allDeliveryDrivers = (deliveriesResult.data || []).filter(d => activeDriverIds.includes(d.id));
                } else {
                    // Si no hay configuraci√≥n del d√≠a, mostrar todos
                    allDeliveryDrivers = deliveriesResult.data || [];
                }

                renderOrders(allOrders);

                // Configurar auto-reload para el pr√≥ximo reinicio
                setupAutoReload();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        /**
         * Actualizar indicador de fecha y hora de reinicio
         */
        async function updateOrdersDateDisplay() {
            try {
                // Obtener fecha actual en hora Colombia usando la zona horaria correcta
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    timeZone: 'America/Bogota'
                };
                const dateString = new Date().toLocaleDateString('es-CO', options);

                // Capitalizar primera letra
                const formattedDate = dateString.charAt(0).toUpperCase() + dateString.slice(1);

                // Actualizar display de fecha
                const dateDisplay = document.getElementById('orders-date-display');
                if (dateDisplay) {
                    dateDisplay.textContent = formattedDate;
                }

                // Obtener y mostrar hora de reinicio configurada
                const { data, error } = await supabase
                    .from('configuracion_general')
                    .select('hora_reinicio')
                    .single();

                if (!error && data) {
                    const resetTime = data.hora_reinicio;
                    const [hours, minutes] = resetTime.split(':');
                    const hour12 = parseInt(hours) > 12 ? parseInt(hours) - 12 : parseInt(hours);
                    const ampm = parseInt(hours) >= 12 ? 'PM' : 'AM';
                    const formattedTime = `${hour12 === 0 ? 12 : hour12}:${minutes} ${ampm}`;

                    const resetTimeDisplay = document.getElementById('orders-reset-time-display');
                    if (resetTimeDisplay) {
                        resetTimeDisplay.textContent = formattedTime;
                    }
                }
            } catch (error) {
                console.error('Error al actualizar display de fecha:', error);
            }
        }

        /**
         * Configurar auto-reload para el pr√≥ximo reinicio
         */
        async function setupAutoReload() {
            // Limpiar interval anterior si existe
            if (ordersAutoReloadInterval) {
                clearInterval(ordersAutoReloadInterval);
            }

            try {
                // Obtener hora de reinicio configurada
                const { data, error } = await supabase
                    .from('configuracion_general')
                    .select('hora_reinicio')
                    .single();

                const resetTime = (data && data.hora_reinicio) ? data.hora_reinicio : '08:00';
                const [hours, minutes] = resetTime.split(':').map(Number);

                // Calcular pr√≥ximo reinicio
                const nowUTC = new Date();
                const colombiaOffsetMs = -5 * 60 * 60 * 1000;
                const nowColombia = new Date(nowUTC.getTime() + colombiaOffsetMs);

                const nextResetColombia = new Date(nowColombia);
                nextResetColombia.setHours(hours, minutes, 0, 0);

                // Si ya pas√≥ la hora de hoy, programar para ma√±ana
                if (nextResetColombia <= nowColombia) {
                    nextResetColombia.setDate(nextResetColombia.getDate() + 1);
                }

                const timeUntilReset = nextResetColombia.getTime() - nowColombia.getTime();

                console.log(`‚è∞ Pr√≥ximo reinicio autom√°tico en: ${Math.floor(timeUntilReset / 1000 / 60)} minutos`);

                // Configurar timer para recargar autom√°ticamente
                ordersAutoReloadInterval = setTimeout(async () => {
                    console.log('üîÑ Reinicio autom√°tico de pedidos...');
                    await loadOrders();
                }, timeUntilReset);

            } catch (error) {
                console.error('Error al configurar auto-reload:', error);
            }
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 30px;">No hay pedidos</td></tr>';
                return;
            }

            orders.forEach(order => {
                // Verificar si el pedido est√° en estado final (no editable)
                const isFinalized = order.estado === 'entregado' || order.estado === 'cancelado';

                const row = tbody.insertRow();
                // Mostrar consecutivo si existe y tiene domiciliario asignado
                let orderDisplay;
                if (order.consecutivo_dia && order.domiciliario_nombre && order.tipo_domiciliario === 'propio') {
                    // Mostrar nombre del domiciliario + consecutivo
                    const nombreCorto = order.domiciliario_nombre.split(' ')[0]; // Primer nombre
                    orderDisplay = `${nombreCorto} #${order.consecutivo_dia}`;
                } else if (order.consecutivo_dia) {
                    orderDisplay = `#${order.consecutivo_dia}`;
                } else {
                    orderDisplay = `#${order.id.substring(0, 8)}`;
                }
                row.innerHTML = `
                    <td style="text-align: center;"><strong>${orderDisplay}</strong></td>
                    <td style="text-align: center;"><strong>${order.cliente}</strong><br><small style="font-size: 11px;">${order.telefono_cliente}</small></td>
                    <td style="text-align: center; font-size: 12px;">${order.direccion}</td>
                    <td style="text-align: center; font-size: 12px;">${order.barrio || '--'}</td>
                    <td style="text-align: center;"><strong>${formatCurrency(order.valor_pedido + order.valor_domicilio)}</strong></td>
                    <td class="tipo-cell" style="text-align: center;"></td>
                    <td class="domiciliario-cell" style="text-align: center;"></td>
                    <td class="metodo-pago-cell" style="text-align: center;"></td>
                    <td class="datafono-cell" style="text-align: center;"></td>
                    <td class="voucher-cell" style="text-align: center;"></td>
                    <td class="estado-cell" style="text-align: center;"></td>
                    <td style="text-align: center;">${order.tiempo_aceptacion ? calculateElapsedTime(order.tiempo_aceptacion) : '--'}</td>
                    <td class="actions-cell" style="text-align: center;"></td>
                `;

                // Select para tipo de domiciliario
                const tipoSelect = document.createElement('select');
                tipoSelect.className = 'btn btn-small';
                tipoSelect.style.width = '100%';
                tipoSelect.innerHTML = `
                    <option value="">Sin asignar</option>
                    <option value="propio">Propio</option>
                    <option value="rappi">Rappi</option>
                `;
                tipoSelect.value = order.tipo_domiciliario || '';
                tipoSelect.disabled = isFinalized;
                if (!isFinalized) {
                    tipoSelect.onchange = () => updateDeliveryType(order.id, tipoSelect.value, row);
                }
                row.cells[5].appendChild(tipoSelect);

                // Select para domiciliario
                const domiciliarioSelect = document.createElement('select');
                domiciliarioSelect.className = 'btn btn-small';
                domiciliarioSelect.style.width = '100%';

                if (order.tipo_domiciliario === 'rappi') {
                    domiciliarioSelect.innerHTML = '<option value="">N/A</option>';
                    domiciliarioSelect.disabled = true;
                } else {
                    domiciliarioSelect.innerHTML = '<option value="">Sin asignar</option>';
                    allDeliveryDrivers.forEach(driver => {
                        const option = document.createElement('option');
                        option.value = driver.id;
                        option.textContent = driver.nombre;
                        domiciliarioSelect.appendChild(option);
                    });
                    domiciliarioSelect.value = order.domiciliario_id || '';
                    domiciliarioSelect.disabled = isFinalized;
                    if (!isFinalized) {
                        domiciliarioSelect.onchange = () => updateDeliveryDriver(order.id, domiciliarioSelect.value);
                    }
                }
                row.cells[6].appendChild(domiciliarioSelect);

                // Select para m√©todo de pago (siempre editable)
                const metodoPagoSelect = document.createElement('select');
                metodoPagoSelect.className = 'btn btn-small';
                metodoPagoSelect.style.width = '100%';
                metodoPagoSelect.innerHTML = `
                    <option value="efectivo">Efectivo</option>
                    <option value="tarjeta">Tarjeta</option>
                `;
                metodoPagoSelect.value = order.metodo_pago || 'efectivo';
                metodoPagoSelect.onchange = () => updatePaymentMethod(order.id, metodoPagoSelect.value);
                row.cells[7].appendChild(metodoPagoSelect);

                // Input para datafono
                const datafonoInput = document.createElement('input');
                datafonoInput.type = 'number';
                datafonoInput.className = 'btn btn-small';
                datafonoInput.style.width = '80px';
                datafonoInput.style.padding = '4px';
                datafonoInput.placeholder = '--';
                datafonoInput.min = '0';
                datafonoInput.step = '1';

                if (order.tipo_domiciliario === 'rappi') {
                    datafonoInput.value = 'N/A';
                    datafonoInput.disabled = true;
                } else {
                    datafonoInput.value = order.numero_datafono || '';
                    datafonoInput.disabled = isFinalized;
                    if (!isFinalized) {
                        datafonoInput.onblur = () => {
                            // Validar que sea entero positivo
                            const value = parseInt(datafonoInput.value);
                            if (datafonoInput.value && (isNaN(value) || value < 0 || !Number.isInteger(parseFloat(datafonoInput.value)))) {
                                showAlert('orders-alert', 'error', 'El datafono debe ser un n√∫mero entero positivo');
                                datafonoInput.value = order.numero_datafono || '';
                                return;
                            }
                            updateDatafono(order.id, datafonoInput.value);
                        };
                    }
                }
                row.cells[8].appendChild(datafonoInput);

                // Select para Estado Voucher
                const voucherSelect = document.createElement('select');
                voucherSelect.className = 'btn btn-small';
                voucherSelect.style.width = '100%';
                voucherSelect.innerHTML = `
                    <option value="pendiente">Pendiente</option>
                    <option value="entregado">Entregado</option>
                `;
                voucherSelect.value = order.estado_voucher || 'pendiente';
                voucherSelect.disabled = isFinalized;
                if (!isFinalized) {
                    voucherSelect.onchange = () => updateVoucherStatus(order.id, voucherSelect.value);
                }
                row.cells[9].appendChild(voucherSelect);

                // Badge de estado
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge status-' + order.estado;
                statusBadge.textContent = order.estado.charAt(0).toUpperCase() + order.estado.slice(1);
                row.cells[10].appendChild(statusBadge);

                // Crear bot√≥n din√°mico Asignar/Rastrear seg√∫n el estado del pedido
                const actionBtn = document.createElement('button');
                actionBtn.className = 'btn btn-small';

                // Si el pedido tiene domiciliario asignado, mostrar bot√≥n Rastrear
                if (order.domiciliario_id || order.tipo_domiciliario === 'rappi') {
                    actionBtn.className = 'btn btn-info btn-small';
                    actionBtn.textContent = 'üìç Rastrear';
                    actionBtn.onclick = () => openTracking(order);
                } else {
                    // Si no tiene domiciliario asignado, mostrar bot√≥n Asignar
                    actionBtn.className = 'btn btn-success btn-small';
                    actionBtn.textContent = '‚úÖ Asignar';
                    actionBtn.onclick = () => assignDelivery(order.id, row);
                }
                row.cells[12].appendChild(actionBtn);

                // Bot√≥n eliminar (solo para pedidos pendientes)
                if (order.estado === 'pendiente') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-small';
                    deleteBtn.textContent = 'üóëÔ∏è';
                    deleteBtn.onclick = () => deleteOrder(order.id);
                    row.cells[12].appendChild(deleteBtn);
                }
            });
        }

        function filterOrders() {
            const status = document.getElementById('filter-status').value;
            const filtered = status ? allOrders.filter(o => o.estado === status) : allOrders;
            renderOrders(filtered);
        }

        async function changeOrderStatus(orderId, newStatus) {
            if (!newStatus) return;
            if (!confirm('¬øCambiar el estado del pedido?')) return;
            
            try {
                const updateData = { estado: newStatus, updated_at: new Date().toISOString() };
                
                if (newStatus === 'entregado') {
                    updateData.tiempo_entrega = Date.now();
                    
                    const order = allOrders.find(o => o.id === orderId);
                    if (order && order.domiciliario_id) {
                        await supabase.from('domiciliarios')
                            .update({ estado: 'disponible' })
                            .eq('id', order.domiciliario_id);
                    }
                } else if (newStatus === 'en_camino') {
                    const order = allOrders.find(o => o.id === orderId);
                    if (order && !order.tiempo_aceptacion) {
                        updateData.tiempo_aceptacion = Date.now();
                    }
                }
                
                await supabase.from('pedidos').update(updateData).eq('id', orderId);
                showAlert('orders-alert', 'success', 'Estado actualizado');
                loadOrders();
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error');
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('¬øEliminar pedido?')) return;
            try {
                await supabase.from('pedidos').delete().eq('id', orderId);
                showAlert('orders-alert', 'success', 'Pedido eliminado');
                loadOrders();
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error');
            }
        }

        async function updateDeliveryType(orderId, tipo, row) {
            try {
                const updateData = {
                    tipo_domiciliario: tipo || null,
                    updated_at: new Date().toISOString()
                };

                // Si cambia a Rappi o sin asignar, limpiar domiciliario
                if (tipo === 'rappi' || !tipo) {
                    updateData.domiciliario_id = null;
                    updateData.domiciliario_nombre = tipo === 'rappi' ? 'Rappi' : null;
                    updateData.domiciliario_telefono = null;
                    updateData.numero_datafono = null;
                }

                await supabase.from('pedidos').update(updateData).eq('id', orderId);
                // No mostrar alerta para no interrumpir la edici√≥n

                // Recargar la fila completa
                loadOrders();
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error al actualizar tipo');
                console.error('Error:', error);
            }
        }

        async function updateDeliveryDriver(orderId, driverId) {
            try {
                const updateData = {
                    domiciliario_id: driverId || null,
                    updated_at: new Date().toISOString()
                };

                // Buscar el domiciliario para obtener su nombre y tel√©fono
                if (driverId) {
                    const driver = allDeliveryDrivers.find(d => d.id === driverId);
                    if (driver) {
                        updateData.domiciliario_nombre = driver.nombre;
                        updateData.domiciliario_telefono = driver.telefono;
                    }
                } else {
                    updateData.domiciliario_nombre = null;
                    updateData.domiciliario_telefono = null;
                }

                await supabase.from('pedidos').update(updateData).eq('id', orderId);
                // No mostrar alerta para no interrumpir la edici√≥n

                // Actualizar el array local
                const orderIndex = allOrders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex] = { ...allOrders[orderIndex], ...updateData };
                }
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error al actualizar domiciliario');
                console.error('Error:', error);
            }
        }

        async function updateDatafono(orderId, numero) {
            try {
                const updateData = {
                    numero_datafono: numero || null,
                    updated_at: new Date().toISOString()
                };

                await supabase.from('pedidos').update(updateData).eq('id', orderId);
                // No mostrar alerta para no interrumpir la edici√≥n

                // Actualizar el array local
                const orderIndex = allOrders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex] = { ...allOrders[orderIndex], ...updateData };
                }
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error al actualizar datafono');
                console.error('Error:', error);
            }
        }

        async function updateVoucherStatus(orderId, estado) {
            try {
                const updateData = {
                    estado_voucher: estado,
                    updated_at: new Date().toISOString()
                };

                await supabase.from('pedidos').update(updateData).eq('id', orderId);
                showAlert('orders-alert', 'success', 'Estado de voucher actualizado');

                // Actualizar el array local
                const orderIndex = allOrders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex] = { ...allOrders[orderIndex], ...updateData };
                }
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error al actualizar estado de voucher');
                console.error('Error:', error);
            }
        }

        async function updatePaymentMethod(orderId, metodo) {
            try {
                const updateData = {
                    metodo_pago: metodo,
                    updated_at: new Date().toISOString()
                };

                await supabase.from('pedidos').update(updateData).eq('id', orderId);
                showAlert('orders-alert', 'success', 'M√©todo de pago actualizado');

                // Actualizar el array local
                const orderIndex = allOrders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex] = { ...allOrders[orderIndex], ...updateData };
                }
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error al actualizar m√©todo de pago');
                console.error('Error:', error);
            }
        }

        async function assignDelivery(orderId, row) {
            try {
                // Obtener valores de los selects de la fila
                const tipoSelect = row.cells[5].querySelector('select');
                const domiciliarioSelect = row.cells[6].querySelector('select');
                const datafonoInput = row.cells[8].querySelector('input');

                const tipo = tipoSelect.value;
                const domiciliarioId = domiciliarioSelect.value;
                const datafono = datafonoInput.value;

                // Validar que se haya seleccionado un tipo
                if (!tipo) {
                    showAlert('orders-alert', 'error', 'Debe seleccionar un tipo de domiciliario');
                    return;
                }

                // Si es tipo propio, validar que se haya seleccionado un domiciliario
                if (tipo === 'propio' && !domiciliarioId) {
                    showAlert('orders-alert', 'error', 'Debe seleccionar un domiciliario');
                    return;
                }

                const updateData = {
                    tipo_domiciliario: tipo,
                    estado: 'asignado',
                    tiempo_aceptacion: Date.now(),
                    updated_at: new Date().toISOString()
                };

                let consecutivo = null;

                // Si es Rappi
                if (tipo === 'rappi') {
                    updateData.domiciliario_id = null;
                    updateData.domiciliario_nombre = 'Rappi';
                    updateData.domiciliario_telefono = null;
                    updateData.numero_datafono = null;
                    // Rappi no necesita consecutivo individual
                } else if (tipo === 'propio') {
                    // Si es domiciliario propio
                    const driver = allDeliveryDrivers.find(d => d.id === domiciliarioId);
                    if (driver) {
                        // Obtener el siguiente consecutivo para ESTE domiciliario espec√≠fico
                        consecutivo = await getNextConsecutivo(domiciliarioId);

                        updateData.domiciliario_id = domiciliarioId;
                        updateData.domiciliario_nombre = driver.nombre;
                        updateData.domiciliario_telefono = driver.telefono;
                        updateData.numero_datafono = datafono || null;
                        updateData.consecutivo_dia = consecutivo;

                        // ‚úÖ NO cambiar el estado del domiciliario a "ocupado"
                        // Esto permite asignar m√∫ltiples pedidos al mismo domiciliario
                        // El estado se actualizar√° cuando inicie la entrega

                        // Enviar notificaci√≥n de WhatsApp con el consecutivo
                        sendWhatsAppNotification(driver.telefono, driver.nombre, consecutivo);
                    }
                }

                // Actualizar el pedido
                await supabase.from('pedidos').update(updateData).eq('id', orderId);

                const successMsg = consecutivo
                    ? `Pedido #${consecutivo} asignado correctamente`
                    : 'Pedido asignado correctamente';
                showAlert('orders-alert', 'success', successMsg);

                // Recargar pedidos para actualizar la interfaz
                loadOrders();
            } catch (error) {
                showAlert('orders-alert', 'error', 'Error al asignar pedido');
                console.error('Error:', error);
            }
        }

        /**
         * Obtener el siguiente n√∫mero consecutivo del d√≠a para un domiciliario espec√≠fico
         * @param {string} domiciliarioId - ID del domiciliario para calcular su consecutivo
         * @returns {number} - Siguiente n√∫mero consecutivo para ese domiciliario
         */
        async function getNextConsecutivo(domiciliarioId) {
            try {
                // Obtener el timestamp de inicio del d√≠a (8 AM) en milisegundos
                const resetTimestamp = await getTodayResetTimestamp();
                const resetTimestampMs = new Date(resetTimestamp).getTime();

                console.log('üî¢ Calculando consecutivo para domiciliario:', domiciliarioId);
                console.log('   - Reset timestamp:', new Date(resetTimestamp).toLocaleString('es-CO', { timeZone: 'America/Bogota' }));
                console.log('   - Reset timestamp ms:', resetTimestampMs);

                // PASO 1: Buscar pedidos que YA TIENEN consecutivo
                const { data: pedidosConConsecutivo, error: error1 } = await supabase
                    .from('pedidos')
                    .select('consecutivo_dia')
                    .eq('domiciliario_id', domiciliarioId)
                    .not('tiempo_aceptacion', 'is', null)
                    .not('consecutivo_dia', 'is', null)
                    .gte('tiempo_aceptacion', resetTimestampMs)
                    .order('consecutivo_dia', { ascending: false })
                    .limit(1);

                if (error1) {
                    console.error('‚ùå Error en query de consecutivo:', error1);
                    throw error1;
                }

                // Si hay pedidos con consecutivo, usar el √∫ltimo + 1
                if (pedidosConConsecutivo && pedidosConConsecutivo.length > 0) {
                    const ultimoConsecutivo = pedidosConConsecutivo[0].consecutivo_dia;
                    const nextConsecutivo = ultimoConsecutivo + 1;
                    console.log('   - √öltimo consecutivo encontrado:', ultimoConsecutivo);
                    console.log('   ‚úÖ Siguiente consecutivo:', nextConsecutivo);
                    return nextConsecutivo;
                }

                // PASO 2: Si no hay pedidos con consecutivo, contar TODOS los pedidos asignados hoy
                const { data: todosPedidos, error: error2 } = await supabase
                    .from('pedidos')
                    .select('id', { count: 'exact', head: false })
                    .eq('domiciliario_id', domiciliarioId)
                    .not('tiempo_aceptacion', 'is', null)
                    .gte('tiempo_aceptacion', resetTimestampMs);

                if (error2) {
                    console.error('‚ùå Error al contar pedidos:', error2);
                    throw error2;
                }

                const cantidadPedidos = todosPedidos?.length || 0;
                const nextConsecutivo = cantidadPedidos + 1;

                console.log('   - Pedidos asignados hoy (sin consecutivo):', cantidadPedidos);
                console.log('   ‚úÖ Siguiente consecutivo:', nextConsecutivo);

                return nextConsecutivo;
            } catch (error) {
                console.error('‚ùå Error al obtener consecutivo:', error);
                // En caso de error, usar timestamp como fallback
                return Math.floor(Date.now() / 1000) % 10000;
            }
        }

        function openTracking(order) {
            currentTrackingOrder = order; // Guardar el pedido actual
            window.currentTrackingOrder = order; // Exponer globalmente para depuraci√≥n
            
            console.log('üìç Abriendo tracking para pedido:', order.id.substring(0, 8));
            console.log('   - Cliente:', order.cliente);
            console.log('   - Domiciliario:', order.domiciliario_nombre || 'Sin asignar');
            console.log('   - Domiciliario ID:', order.domiciliario_id?.substring(0, 8) || 'N/A');
            
            document.getElementById('tracking-modal').classList.add('active');
            document.getElementById('tracking-info').innerHTML = `
                <div><strong>Pedido ID:</strong> #${order.id.substring(0, 8)}</div>
                <div><strong>Cliente:</strong> ${order.cliente}</div>
                <div><strong>Direcci√≥n:</strong> ${order.direccion}</div>
                <div><strong>Domiciliario:</strong> ${order.domiciliario_nombre || 'Sin asignar'}</div>
                <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 12px;">
                    üìç La ubicaci√≥n se actualizar√° autom√°ticamente cuando el domiciliario acepte compartir su ubicaci√≥n.
                </div>
            `;
            
            // Inicializar mapa con timeout para asegurar que el DOM est√° listo
            setTimeout(() => {
                initializeTrackingMap();
                
                // Mostrar informaci√≥n inicial sin cargar ubicaci√≥n GPS
                // La ubicaci√≥n GPS se cargar√° autom√°ticamente cuando est√© disponible
                if (order.domiciliario_id) {
                    console.log('‚ÑπÔ∏è Modal abierto. Configurando actualizaci√≥n autom√°tica...');
                    // Mostrar estado inicial
                    document.getElementById('tracking-status').className = 'status-badge status-' + order.estado;
                    document.getElementById('tracking-status').textContent = order.estado.charAt(0).toUpperCase() + order.estado.slice(1);
                    document.getElementById('tracking-time').textContent = order.tiempo_aceptacion ? calculateElapsedTime(order.tiempo_aceptacion) : '--';
                    document.getElementById('tracking-update-time').textContent = 'Esperando ubicaci√≥n...';
                    
                    // Cargar ubicaci√≥n inicial
                    loadDeliveryLocation(order.domiciliario_id);
                    
                    // Iniciar suscripci√≥n en tiempo real
                    subscribeToLocationUpdates(order.domiciliario_id);
                } else {
                    // Si no hay domiciliario asignado
                    console.warn('‚ö†Ô∏è Pedido sin domiciliario asignado');
                    document.getElementById('tracking-status').innerHTML = '<span class="status-badge status-pendiente">Sin asignar</span>';
                    document.getElementById('tracking-time').textContent = '--';
                    document.getElementById('tracking-update-time').textContent = new Date().toLocaleTimeString('es-CO');
                }
            }, 100); // Peque√±o delay para asegurar que el modal est√© visible
        }
        
        // Nueva funci√≥n para inicializar o reinicializar el mapa
        function initializeTrackingMap() {
            console.log('üó∫Ô∏è ========== INICIO initializeTrackingMap ==========');
            
            // Verificar que el elemento existe
            const mapElement = document.getElementById('tracking-map');
            if (!mapElement) {
                console.error('‚ùå ERROR CR√çTICO: El elemento tracking-map no existe en el DOM');
                console.error('   Esto indica un problema con la estructura HTML');
                return false;
            }
            console.log('   ‚úÖ Elemento tracking-map encontrado');
            
            try {
                // Si el mapa ya existe, removerlo primero
                if (trackingMap) {
                    console.log('   üóëÔ∏è Removiendo mapa anterior...');
                    trackingMap.remove();
                    trackingMap = null;
                    window.trackingMap = null;
                    console.log('   ‚úÖ Mapa anterior removido');
                }
                
                // Limpiar el contenedor del mapa
                console.log('   üßπ Limpiando contenedor...');
                mapElement.innerHTML = '';
                
                // Crear nuevo mapa
                console.log('   üÜï Creando nuevo mapa...');
                trackingMap = L.map('tracking-map').setView([4.7110, -74.0721], 13);
                
                // Agregar capa de tiles
                console.log('   üó∫Ô∏è Agregando capa de tiles...');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(trackingMap);
                
                // Exponer globalmente para depuraci√≥n
                window.trackingMap = trackingMap;
                
                console.log('   ‚úÖ Mapa creado y configurado');
                
                // Forzar re-render del mapa
                setTimeout(() => {
                    if (trackingMap) {
                        trackingMap.invalidateSize();
                        console.log('   üîÑ Mapa invalidado para re-render');
                    }
                }, 100);
                
                console.log('‚úÖ ========== FIN initializeTrackingMap - √âXITO ==========');
                return true;
                
            } catch (error) {
                console.error('‚ùå ========== FIN initializeTrackingMap - ERROR ==========');
                console.error('Error completo:', error);
                alert('Error al inicializar el mapa. Intenta recargar la p√°gina.\n\nError: ' + error.message);
                return false;
            }
        }
        
        // Exponer globalmente
        window.openTracking = openTracking;
        window.initializeTrackingMap = initializeTrackingMap;

        // Funci√≥n para suscribirse a actualizaciones de ubicaci√≥n en tiempo real
        function subscribeToLocationUpdates(deliveryId) {
            console.log('üîî Iniciando suscripci√≥n a actualizaciones de ubicaci√≥n...');
            
            // Limpiar suscripci√≥n anterior si existe
            if (locationSubscription) {
                console.log('   üóëÔ∏è Limpiando suscripci√≥n anterior...');
                supabase.removeChannel(locationSubscription);
                locationSubscription = null;
            }
            
            // Crear nueva suscripci√≥n
            locationSubscription = supabase
                .channel('location-updates')
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'domiciliarios',
                        filter: `id=eq.${deliveryId}`
                    },
                    (payload) => {
                        console.log('üìç ¬°Ubicaci√≥n actualizada autom√°ticamente!', payload);
                        
                        // Verificar si hay ubicaci√≥n en el payload
                        if (payload.new && payload.new.ubicacion) {
                            console.log('   ‚úÖ Nueva ubicaci√≥n detectada, actualizando mapa...');
                            
                            // Actualizar el mapa con la nueva ubicaci√≥n
                            loadDeliveryLocation(deliveryId);
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('üì° Estado de suscripci√≥n:', status);
                });
            
            console.log('‚úÖ Suscripci√≥n activa para domiciliario:', deliveryId.substring(0, 8));
        }

        async function updateTrackingInfo() {
            console.log('üìç ========== INICIO updateTrackingInfo ==========');
            
            if (!currentTrackingOrder) {
                console.warn('‚ö†Ô∏è No hay pedido en seguimiento');
                alert('No hay pedido en seguimiento. Por favor cierra y abre el modal de nuevo.');
                return;
            }
            
            console.log('üîÑ Actualizando informaci√≥n del tracking...');
            console.log('   - Pedido ID:', currentTrackingOrder.id.substring(0, 8));
            console.log('   - Domiciliario ID:', currentTrackingOrder.domiciliario_id ? currentTrackingOrder.domiciliario_id.substring(0, 8) : 'null');
            
            try {
                // 1. Obtener informaci√≥n actualizada del pedido
                console.log('1Ô∏è‚É£ Consultando pedido actualizado...');
                const { data: orderData, error: orderError } = await supabase
                    .from('pedidos')
                    .select('*')
                    .eq('id', currentTrackingOrder.id)
                    .single();
                
                if (orderError) {
                    console.error('‚ùå Error al consultar pedido:', orderError);
                    throw orderError;
                }
                
                if (orderData) {
                    console.log('   ‚úÖ Pedido obtenido');
                    // Actualizar el pedido actual con datos frescos
                    currentTrackingOrder = orderData;
                    window.currentTrackingOrder = orderData;
                    
                    // 2. Actualizar el ESTADO
                    console.log('2Ô∏è‚É£ Actualizando estado del pedido...');
                    const statusBadge = document.getElementById('tracking-status');
                    if (statusBadge) {
                        statusBadge.className = 'status-badge status-' + orderData.estado;
                        statusBadge.textContent = orderData.estado.charAt(0).toUpperCase() + orderData.estado.slice(1);
                        console.log('   ‚úÖ Estado actualizado:', orderData.estado);
                    } else {
                        console.warn('   ‚ö†Ô∏è Elemento tracking-status no encontrado');
                    }
                    
                    // 3. Actualizar el TIEMPO TRANSCURRIDO
                    console.log('3Ô∏è‚É£ Actualizando tiempo transcurrido...');
                    const timeSpan = document.getElementById('tracking-time');
                    if (timeSpan) {
                        if (orderData.tiempo_aceptacion) {
                            timeSpan.textContent = calculateElapsedTime(orderData.tiempo_aceptacion);
                            console.log('   ‚úÖ Tiempo actualizado');
                        } else {
                            timeSpan.textContent = '--';
                            console.log('   ‚ÑπÔ∏è No hay tiempo de aceptaci√≥n');
                        }
                    } else {
                        console.warn('   ‚ö†Ô∏è Elemento tracking-time no encontrado');
                    }
                }
                
                // 4. Actualizar la UBICACI√ìN GPS si hay domiciliario
                if (currentTrackingOrder.domiciliario_id) {
                    console.log('4Ô∏è‚É£ Actualizando ubicaci√≥n GPS del domiciliario...');
                    console.log('   - ID:', currentTrackingOrder.domiciliario_id.substring(0, 8));
                    console.log('   - Mapa existe:', !!trackingMap);
                    
                    await loadDeliveryLocation(currentTrackingOrder.domiciliario_id);
                    
                    console.log('   ‚úÖ Ubicaci√≥n GPS actualizada');
                } else {
                    console.warn('‚ö†Ô∏è No hay domiciliario asignado a este pedido');
                    alert('Este pedido no tiene un domiciliario asignado todav√≠a.');
                }
                
                // 5. Actualizar hora de √∫ltima actualizaci√≥n
                console.log('5Ô∏è‚É£ Actualizando hora...');
                const updateTimeEl = document.getElementById('tracking-update-time');
                if (updateTimeEl) {
                    updateTimeEl.textContent = new Date().toLocaleTimeString('es-CO');
                    console.log('   ‚úÖ Hora actualizada');
                } else {
                    console.warn('   ‚ö†Ô∏è Elemento tracking-update-time no encontrado');
                }
                
                console.log('‚úÖ ========== FIN updateTrackingInfo - √âXITO ==========');
                
            } catch (error) {
                console.error('‚ùå ========== FIN updateTrackingInfo - ERROR ==========');
                console.error('Error completo:', error);
                alert('Error al actualizar el tracking. Revisa la consola (F12) para m√°s detalles.\n\nError: ' + error.message);
            }
        }
        
        // Exponer funci√≥n globalmente para el event listener
        window.updateTrackingInfo = updateTrackingInfo;

        async function loadDeliveryLocation(deliveryId) {
            console.log('üìç ========== INICIO loadDeliveryLocation ==========');
            console.log('   - Domiciliario ID:', deliveryId.substring(0, 8));
            console.log('   - Timestamp de consulta:', new Date().toLocaleTimeString('es-CO'));
            
            // Verificar que el mapa est√© inicializado
            if (!trackingMap) {
                console.warn('‚ö†Ô∏è Mapa no inicializado, intentando inicializar...');
                const initialized = initializeTrackingMap();
                if (!initialized) {
                    console.error('‚ùå No se pudo inicializar el mapa');
                    alert('Error: No se pudo inicializar el mapa. Intenta cerrar y abrir el modal de nuevo.');
                    return;
                }
                console.log('   ‚úÖ Mapa inicializado correctamente');
            } else {
                console.log('   ‚úÖ Mapa ya existe');
            }
            
            try {
                console.log('   üîç Consultando ubicaci√≥n en la base de datos (sin cach√©)...');
                
                // Hacer la consulta SIN cach√© para obtener datos frescos
                const { data, error } = await supabase
                    .from('domiciliarios')
                    .select('ubicacion, nombre, updated_at')
                    .eq('id', deliveryId)
                    .single();
                
                if (error) {
                    console.error('‚ùå Error al consultar ubicaci√≥n:', error);
                    throw error;
                }
                
                console.log('   üì¶ Datos recibidos completos:', {
                    nombre: data?.nombre,
                    updated_at: data?.updated_at,
                    tiene_ubicacion: !!data?.ubicacion,
                    ubicacion_completa: data?.ubicacion
                });
                
                if (data?.ubicacion) {
                    console.log('   üìç Detalles de ubicaci√≥n:');
                    console.log('      - Latitud:', data.ubicacion.lat);
                    console.log('      - Longitud:', data.ubicacion.lng);
                    console.log('      - Timestamp:', data.ubicacion.timestamp);
                    console.log('      - Precisi√≥n:', data.ubicacion.accuracy ? `${Math.round(data.ubicacion.accuracy)}m` : 'N/A');
                }
                
                if (data && data.ubicacion && data.ubicacion.lat && data.ubicacion.lng) {
                    const lat = parseFloat(data.ubicacion.lat);
                    const lng = parseFloat(data.ubicacion.lng);
                    
                    console.log('‚úÖ Ubicaci√≥n GPS encontrada y validada:', {
                        lat: lat.toFixed(6),
                        lng: lng.toFixed(6),
                        timestamp: data.ubicacion.timestamp,
                        nombre: data.nombre
                    });
                    
                    // Remover marcador anterior
                    if (trackingMarker) {
                        console.log('   üóëÔ∏è Removiendo marcador anterior en posici√≥n:', trackingMarker.getLatLng());
                        trackingMap.removeLayer(trackingMarker);
                        trackingMarker = null;
                        window.trackingMarker = null;
                        console.log('   ‚úÖ Marcador anterior removido');
                    }
                    
                    // Calcular tiempo desde √∫ltima actualizaci√≥n
                    const lastUpdate = new Date(data.ubicacion.timestamp);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastUpdate) / 60000);
                    const timeAgo = diffMinutes === 0 ? 'Hace menos de 1 minuto' : 
                                   diffMinutes === 1 ? 'Hace 1 minuto' : 
                                   diffMinutes > 60 ? `Hace ${Math.floor(diffMinutes/60)}h ${diffMinutes%60}m` :
                                   `Hace ${diffMinutes} minutos`;
                    
                    const accuracy = data.ubicacion.accuracy ? ` (¬±${Math.round(data.ubicacion.accuracy)}m)` : '';
                    
                    // Color del marcador seg√∫n antig√ºedad
                    let markerColor = '#27ae60'; // Verde por defecto
                    if (diffMinutes > 30) markerColor = '#e74c3c'; // Rojo si es muy antigua
                    else if (diffMinutes > 10) markerColor = '#f39c12'; // Amarillo si es un poco antigua
                    
                    console.log('   ‚è∞ Antig√ºedad de la ubicaci√≥n:', diffMinutes, 'minutos -', 
                        markerColor === '#27ae60' ? 'üü¢ Reciente' : 
                        markerColor === '#f39c12' ? 'üü° Antigua' : 
                        'üî¥ Muy antigua');
                    
                    // Crear icono personalizado
                    console.log('   üé® Creando nuevo marcador personalizado...');
                    const iconDiv = document.createElement('div');
                    iconDiv.style.cssText = `background:${markerColor};width:40px;height:40px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:20px`;
                    iconDiv.textContent = 'üèçÔ∏è';
                    const customIcon = L.divIcon({ 
                        className: 'custom-marker', 
                        html: iconDiv.outerHTML, 
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });
                    
                    // Crear y agregar marcador en la NUEVA ubicaci√≥n
                    console.log('   üìç Agregando NUEVO marcador al mapa en:', { lat, lng });
                    trackingMarker = L.marker([lat, lng], { icon: customIcon })
                        .addTo(trackingMap);
                    
                    console.log('   ‚úÖ Marcador agregado exitosamente en posici√≥n:', trackingMarker.getLatLng());
                    
                    trackingMarker.bindPopup(`
                        <div style="text-align: center;">
                            <strong style="font-size: 14px;">${data.nombre}</strong><br>
                            <div style="margin: 5px 0;">üìç Ubicaci√≥n actual</div>
                            <small style="color: #666;">üïí ${timeAgo}${accuracy}</small><br>
                            <small style="color: #999;">Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}</small>
                        </div>
                    `).openPopup();
                    
                    // Centrar el mapa en la NUEVA ubicaci√≥n
                    console.log('   üó∫Ô∏è Centrando mapa en la nueva ubicaci√≥n...');
                    trackingMap.setView([lat, lng], 16);
                    console.log('   ‚úÖ Mapa centrado en:', trackingMap.getCenter());
                    
                    // Forzar re-render del mapa
                    setTimeout(() => {
                        if (trackingMap) {
                            trackingMap.invalidateSize();
                            console.log('   üîÑ Mapa re-renderizado y actualizado');
                        }
                    }, 100);
                    
                    // Exponer marcador globalmente para depuraci√≥n
                    window.trackingMarker = trackingMarker;
                    window.lastLocationUpdate = {
                        lat,
                        lng,
                        timestamp: data.ubicacion.timestamp,
                        nombre: data.nombre,
                        updatedAt: new Date().toISOString()
                    };
                    
                    console.log('‚úÖ ========== FIN loadDeliveryLocation - MARCADOR ACTUALIZADO EXITOSAMENTE ==========');
                    console.log('   üíæ √öltima actualizaci√≥n guardada en window.lastLocationUpdate para debug');
                    
                } else {
                    // No hay ubicaci√≥n disponible
                    console.warn('‚ö†Ô∏è ========== FIN loadDeliveryLocation - SIN UBICACI√ìN GPS ==========');
                    console.warn('   El domiciliario no tiene ubicaci√≥n GPS registrada');
                    console.log('   üì± El domiciliario debe:');
                    console.log('   1. Abrir su app de domiciliarios');
                    console.log('   2. Iniciar sesi√≥n');
                    console.log('   3. Activar GPS y permitir permisos de ubicaci√≥n');
                    console.log('   4. La app actualizar√° su ubicaci√≥n autom√°ticamente');
                    
                    alert('El domiciliario no tiene ubicaci√≥n GPS registrada.\n\nAseg√∫rate de que:\n- Tiene la app de domiciliarios abierta\n- Ha iniciado sesi√≥n\n- Tiene el GPS activado');
                    
                    if (trackingMarker) {
                        trackingMap.removeLayer(trackingMarker);
                        trackingMarker = null;
                        window.trackingMarker = null;
                    }
                }
            } catch (error) {
                console.error('‚ùå ========== FIN loadDeliveryLocation - ERROR ==========');
                console.error('Error completo:', error);
                alert('Error al cargar la ubicaci√≥n del domiciliario.\n\nError: ' + error.message);
            }
        }

        function closeTrackingModal() {
            console.log('‚ùå Cerrando modal de tracking');
            document.getElementById('tracking-modal').classList.remove('active');
            
            // Limpiar suscripci√≥n de ubicaci√≥n
            if (locationSubscription) {
                console.log('   üóëÔ∏è Limpiando suscripci√≥n de ubicaci√≥n...');
                supabase.removeChannel(locationSubscription);
                locationSubscription = null;
            }
            
            // Limpiar marcador
            if (trackingMarker && trackingMap) {
                try {
                    trackingMap.removeLayer(trackingMarker);
                    console.log('   - Marcador removido');
                } catch (error) {
                    console.warn('   - Error al remover marcador:', error);
                }
            }
            trackingMarker = null;
            window.trackingMarker = null;
            
            // Limpiar pedido actual
            currentTrackingOrder = null;
            window.currentTrackingOrder = null;
            
            // NO destruir el mapa, solo dejarlo para reutilizar
            // trackingMap se reutilizar√° en la pr√≥xima apertura
            console.log('‚úÖ Modal cerrado correctamente');
        }

        function openOrderModal(order) {
            currentOrderId = order ? order.id : null;
            document.getElementById('order-modal-title').textContent = order ? 'Editar Pedido' : 'Nuevo Pedido';
            if (order) {
                document.getElementById('order-customer-name').value = order.cliente;
                document.getElementById('order-customer-phone').value = order.telefono_cliente;
                document.getElementById('order-address').value = order.direccion;
                document.getElementById('order-neighborhood').value = order.barrio || '';
                document.getElementById('order-value').value = formatNumberWithDots(order.valor_pedido);
                document.getElementById('order-delivery-fee').value = formatNumberWithDots(order.valor_domicilio);
                document.getElementById('order-payment-method').value = order.metodo_pago;
                document.getElementById('order-notes').value = order.notas || '';
                calculateTotal();
            } else {
                document.getElementById('order-form').reset();
                document.getElementById('order-customer-phone').value = '+57';
            }
            document.getElementById('order-modal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
            document.getElementById('order-form').reset();
            document.getElementById('order-customer-phone').value = '+57';
            currentOrderId = null;
        }

        function calculateTotal() {
            const orderValue = parseFormattedNumber(document.getElementById('order-value').value);
            const deliveryFee = parseFormattedNumber(document.getElementById('order-delivery-fee').value);
            document.getElementById('order-total').value = formatCurrency(orderValue + deliveryFee);
        }

        document.getElementById('order-value').addEventListener('input', function() { formatCurrencyInput(this); });
        document.getElementById('order-delivery-fee').addEventListener('input', function() { formatCurrencyInput(this); });

        document.getElementById('btn-new-order').addEventListener('click', () => openOrderModal(null));
        document.getElementById('btn-cancel-order').addEventListener('click', closeOrderModal);
        document.getElementById('btn-refresh-orders').addEventListener('click', async () => {
            console.log('üîÑ Actualizando lista de pedidos...');
            const btn = document.getElementById('btn-refresh-orders');
            const originalText = btn.textContent;
            
            // Cambiar texto del bot√≥n para dar feedback visual
            btn.textContent = '‚è≥ Actualizando...';
            btn.disabled = true;
            
            try {
                await loadOrders();
                btn.textContent = '‚úÖ Actualizado';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 1000);
            } catch (error) {
                console.error('Error al actualizar pedidos:', error);
                btn.textContent = '‚ùå Error';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        });
        document.getElementById('btn-close-tracking').addEventListener('click', closeTrackingModal);
        document.getElementById('btn-refresh-tracking').addEventListener('click', async () => {
            console.log('üîÑ Bot√≥n de actualizaci√≥n clickeado');
            console.log('   - currentTrackingOrder:', currentTrackingOrder ? currentTrackingOrder.id.substring(0, 8) : 'null');
            console.log('   - trackingMap existe:', !!trackingMap);
            
            if (typeof updateTrackingInfo === 'function') {
                try {
                    await updateTrackingInfo();
                } catch (error) {
                    console.error('‚ùå Error al ejecutar updateTrackingInfo:', error);
                    alert('Error al actualizar: ' + error.message);
                }
            } else {
                console.error('‚ùå updateTrackingInfo no est√° disponible');
                alert('Error: La funci√≥n de actualizaci√≥n no est√° disponible');
            }
        });
        document.getElementById('filter-status').addEventListener('change', filterOrders);
        document.getElementById('order-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeOrderModal(); });
        document.getElementById('tracking-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeTrackingModal(); });

        document.getElementById('order-form').addEventListener('submit', async e => {
            e.preventDefault();

            const orderData = {
                cliente: document.getElementById('order-customer-name').value,
                telefono_cliente: document.getElementById('order-customer-phone').value,
                direccion: document.getElementById('order-address').value,
                barrio: document.getElementById('order-neighborhood').value,
                valor_pedido: parseFormattedNumber(document.getElementById('order-value').value),
                valor_domicilio: parseFormattedNumber(document.getElementById('order-delivery-fee').value),
                metodo_pago: document.getElementById('order-payment-method').value,
                notas: document.getElementById('order-notes').value,
                updated_at: new Date().toISOString()
                // Los campos de domiciliario se asignar√°n posteriormente en el m√≥dulo de gesti√≥n
            }

            try {
                let orderId;
                if (currentOrderId) {
                    // Al editar, NO cambiar el estado del pedido
                    const { data, error } = await supabase.from('pedidos').update(orderData).eq('id', currentOrderId);
                    if (error) throw error;
                    orderId = currentOrderId;
                    showAlert('orders-alert', 'success', 'Pedido actualizado');
                } else {
                    // Solo al crear un nuevo pedido, establecer estado como pendiente
                    orderData.estado = 'pendiente';
                    orderData.created_at = new Date().toISOString();
                    const { data, error } = await supabase.from('pedidos').insert([orderData]).select();
                    if (error) {
                        console.error('Error detallado:', error);
                        throw error;
                    }
                    orderId = data[0].id;
                    showAlert('orders-alert', 'success', 'Pedido creado');
                }

                if (orderData.domiciliario_id) {
                    await supabase.from('domiciliarios')
                        .update({ estado: 'ocupado' })
                        .eq('id', orderData.domiciliario_id);

                    // Si hay consecutivo, incluirlo en la notificaci√≥n
                    const consecutivo = orderData.consecutivo_dia || '?';
                    sendWhatsAppNotification(orderData.domiciliario_telefono, orderData.domiciliario_nombre, consecutivo);
                }

                closeOrderModal();
                loadOrders();
            } catch (error) {
                console.error('Error completo al guardar pedido:', error);
                const errorMsg = error.message || error.hint || 'Error desconocido';
                showAlert('orders-alert', 'error', 'Error al guardar: ' + errorMsg);
            }
        });

        // ========== DASHBOARD ==========
        
        // Funci√≥n para cargar opciones de filtros din√°micamente
        async function loadDashboardFilters() {
            if (!supabase) return;
            try {
                // Cargar domiciliarios para el filtro
                const deliveriesResult = await supabase.from('domiciliarios').select('*').order('nombre');
                const deliverySelect = document.getElementById('filter-delivery-person');
                deliverySelect.innerHTML = '<option value="">Todos</option>';
                
                // Agregar Rappi
                const rappiOption = document.createElement('option');
                rappiOption.value = 'rappi';
                rappiOption.textContent = 'Rappi';
                deliverySelect.appendChild(rappiOption);
                
                // Agregar domiciliarios propios
                if (deliveriesResult.data) {
                    deliveriesResult.data.forEach(d => {
                        const option = document.createElement('option');
                        option.value = d.id;
                        option.textContent = d.nombre;
                        deliverySelect.appendChild(option);
                    });
                }
                
                // Cargar datafonos √∫nicos
                const ordersResult = await supabase.from('pedidos').select('numero_datafono');
                const dataphones = [...new Set(ordersResult.data?.map(o => o.numero_datafono).filter(d => d))];
                const dataphoneSelect = document.getElementById('filter-dataphone');
                dataphoneSelect.innerHTML = '<option value="">Todos</option>';
                dataphones.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d;
                    option.textContent = d;
                    dataphoneSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error cargando filtros:', error);
            }
        }
        
        // Funci√≥n para aplicar filtros
        function getFilteredOrders(orders) {
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const deliveryType = document.getElementById('filter-delivery-type').value;
            const deliveryPerson = document.getElementById('filter-delivery-person').value;
            const dataphone = document.getElementById('filter-dataphone').value;
            const paymentMethod = document.getElementById('filter-payment-method').value;
            const voucherStatus = document.getElementById('filter-voucher-status').value;
            const orderStatus = document.getElementById('filter-order-status').value;

            let filtered = orders;

            // Filtro por rango de fechas
            if (dateFrom) {
                const fromDate = new Date(dateFrom + 'T00:00:00');
                filtered = filtered.filter(o => new Date(o.created_at) >= fromDate);
            }

            if (dateTo) {
                const toDate = new Date(dateTo + 'T23:59:59');
                filtered = filtered.filter(o => new Date(o.created_at) <= toDate);
            }

            // Filtro por tipo de domiciliario
            if (deliveryType) {
                filtered = filtered.filter(o => o.tipo_domiciliario === deliveryType);
            }

            // Filtro por domiciliario
            if (deliveryPerson) {
                if (deliveryPerson === 'rappi') {
                    filtered = filtered.filter(o => o.domiciliario_nombre === 'Rappi');
                } else {
                    filtered = filtered.filter(o => o.domiciliario_id === deliveryPerson);
                }
            }

            // Filtro por datafono
            if (dataphone) {
                filtered = filtered.filter(o => o.numero_datafono == dataphone);
            }

            // Filtro por m√©todo de pago
            if (paymentMethod) {
                filtered = filtered.filter(o => o.metodo_pago === paymentMethod);
            }

            // Filtro por estado de voucher
            if (voucherStatus) {
                filtered = filtered.filter(o => o.estado_voucher === voucherStatus);
            }

            // Filtro por estado de pedido
            if (orderStatus) {
                filtered = filtered.filter(o => o.estado === orderStatus);
            }

            return filtered;
        }
        
        // Funci√≥n para actualizar el display del rango de fechas
        function updateDateRangeDisplay() {
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const display = document.getElementById('date-range-display');

            if (dateFrom && dateTo) {
                const fromFormatted = new Date(dateFrom + 'T12:00:00').toLocaleDateString('es-CO');
                const toFormatted = new Date(dateTo + 'T12:00:00').toLocaleDateString('es-CO');
                display.textContent = `Mostrando pedidos desde ${fromFormatted} hasta ${toFormatted}`;
            } else if (dateFrom) {
                const fromFormatted = new Date(dateFrom + 'T12:00:00').toLocaleDateString('es-CO');
                display.textContent = `Mostrando pedidos desde ${fromFormatted}`;
            } else if (dateTo) {
                const toFormatted = new Date(dateTo + 'T12:00:00').toLocaleDateString('es-CO');
                display.textContent = `Mostrando pedidos hasta ${toFormatted}`;
            } else {
                display.textContent = 'Mostrando todos los pedidos';
            }
        }
        
        async function loadDashboard() {
            if (!supabase) return;
            try {
                const ordersResult = await supabase.from('pedidos').select('*');
                const orders = ordersResult.data || [];
                
                // Aplicar filtros
                const filteredOrders = getFilteredOrders(orders);
                
                // Calcular m√©tricas
                const totalOrders = filteredOrders.length;
                const orderIncome = filteredOrders.reduce((sum, o) => sum + (o.valor_pedido || 0), 0);
                const deliveryIncome = filteredOrders.reduce((sum, o) => sum + (o.valor_domicilio || 0), 0);
                
                // Calcular tiempo promedio solo de pedidos entregados
                const deliveredOrders = filteredOrders.filter(o => 
                    o.estado === 'entregado' && o.tiempo_aceptacion && o.tiempo_entrega
                );
                let avgTime = '--';
                if (deliveredOrders.length > 0) {
                    const totalTime = deliveredOrders.reduce((sum, o) => 
                        sum + (o.tiempo_entrega - o.tiempo_aceptacion), 0
                    );
                    const avgMinutes = Math.round((totalTime / deliveredOrders.length) / 60000);
                    avgTime = Math.floor(avgMinutes / 60) + 'h ' + (avgMinutes % 60) + 'm';
                }
                
                // Actualizar m√©tricas en el DOM
                document.getElementById('stat-total-orders').textContent = totalOrders;
                document.getElementById('stat-order-income').textContent = formatCurrency(orderIncome);
                document.getElementById('stat-delivery-income').textContent = formatCurrency(deliveryIncome);
                document.getElementById('stat-avg-time').textContent = avgTime;
                
                // Actualizar gr√°ficos y tablas
                renderStatusChart(filteredOrders);
                renderIncomeDistributionChart(filteredOrders);
                renderIncomeChart(filteredOrders);
                renderFilteredOrdersTable(filteredOrders);
                
                // Actualizar display del rango
                updateDateRangeDisplay();
                
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderStatusChart(orders) {
            const statusCount = { pendiente: 0, asignado: 0, en_camino: 0, entregado: 0, cancelado: 0 };
            const statusLabels = { 
                pendiente: 'Pendiente', 
                asignado: 'Asignado', 
                en_camino: 'En Camino', 
                entregado: 'Entregado', 
                cancelado: 'Cancelado' 
            };
            const statusColors = { 
                pendiente: '#f39c12', 
                asignado: '#3498db', 
                en_camino: '#2ecc71', 
                entregado: '#27ae60', 
                cancelado: '#e74c3c' 
            };
            
            // Contar pedidos por estado
            orders.forEach(o => { 
                if (statusCount[o.estado] !== undefined) {
                    statusCount[o.estado]++; 
                }
            });
            
            // Filtrar solo los estados que tienen pedidos
            const activeStates = Object.keys(statusCount).filter(state => statusCount[state] > 0);
            
            const ctx = document.getElementById('status-chart');
            if (statusChart) statusChart.destroy();
            
            // Si no hay pedidos, mostrar mensaje
            if (activeStates.length === 0 || orders.length === 0) {
                statusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Sin datos'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#ecf0f1']
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { display: false },
                            tooltip: { enabled: false }
                        } 
                    }
                });
                return;
            }
            
            // Crear gr√°fico con solo los estados activos
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: activeStates.map(state => statusLabels[state]),
                    datasets: [{
                        data: activeStates.map(state => statusCount[state]),
                        backgroundColor: activeStates.map(state => statusColors[state])
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    } 
                }
            });
        }
        
        function renderIncomeDistributionChart(orders) {
            const orderIncome = orders.reduce((sum, o) => sum + (o.valor_pedido || 0), 0);
            const deliveryIncome = orders.reduce((sum, o) => sum + (o.valor_domicilio || 0), 0);
            
            const ctx = document.getElementById('income-distribution-chart');
            if (incomeDistributionChart) incomeDistributionChart.destroy();
            
            // Si no hay ingresos, mostrar mensaje
            if (orderIncome === 0 && deliveryIncome === 0) {
                incomeDistributionChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Sin datos'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#ecf0f1']
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { display: false },
                            tooltip: { enabled: false }
                        } 
                    }
                });
                return;
            }
            
            // Preparar datos y labels solo para los que tienen valor
            const labels = [];
            const data = [];
            const colors = [];
            
            if (orderIncome > 0) {
                labels.push('Ingresos por Pedido');
                data.push(orderIncome);
                colors.push('#43e97b');
            }
            
            if (deliveryIncome > 0) {
                labels.push('Ingresos por Domicilio');
                data.push(deliveryIncome);
                colors.push('#f093fb');
            }
            
            incomeDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    } 
                }
            });
        }

        function renderIncomeChart(orders) {
            // Obtener rango de fechas del filtro
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            
            let days = [];
            const incomeByDay = {};
            
            if (dateFrom && dateTo) {
                // Si hay rango definido, usar ese rango
                const startDate = new Date(dateFrom + 'T12:00:00');
                const endDate = new Date(dateTo + 'T12:00:00');
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                for (let i = 0; i <= diffDays; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    const key = date.toISOString().split('T')[0];
                    const label = date.toLocaleDateString('es-CO', { month: 'short', day: 'numeric' });
                    days.push({ key, label });
                    incomeByDay[key] = 0;
                }
            } else {
                // Sin rango, mostrar √∫ltimos 7 d√≠as
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const key = date.toISOString().split('T')[0];
                    const label = date.toLocaleDateString('es-CO', { month: 'short', day: 'numeric' });
                    days.push({ key, label });
                    incomeByDay[key] = 0;
                }
            }
            
            orders.forEach(o => {
                if (o.created_at) {
                    const key = new Date(o.created_at).toISOString().split('T')[0];
                    if (incomeByDay[key] !== undefined) {
                        incomeByDay[key] += (o.valor_pedido || 0) + (o.valor_domicilio || 0);
                    }
                }
            });
            
            const ctx = document.getElementById('income-chart');
            if (incomeChart) incomeChart.destroy();
            
            // Verificar si hay datos
            const hasData = Object.values(incomeByDay).some(value => value > 0);
            
            incomeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days.map(d => d.label),
                    datasets: [{
                        label: 'Ingresos Totales',
                        data: days.map(d => incomeByDay[d.key]),
                        backgroundColor: hasData ? 'rgba(52, 152, 219, 0.6)' : 'rgba(236, 240, 241, 0.6)',
                        borderColor: hasData ? '#3498db' : '#bdc3c7',
                        borderWidth: 2
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            enabled: hasData,
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderFilteredOrdersTable(orders) {
            const tbody = document.getElementById('filtered-orders-table');
            tbody.innerHTML = '';
            
            // Ordenar por fecha descendente
            const sortedOrders = orders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            if (sortedOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 30px;">No hay pedidos que coincidan con los filtros</td></tr>';
                return;
            }
            
            sortedOrders.forEach(order => {
                const row = tbody.insertRow();
                const orderDate = new Date(order.created_at).toLocaleDateString('es-CO', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                row.innerHTML = `
                    <td><strong>#${order.id.substring(0, 8)}</strong></td>
                    <td>${orderDate}</td>
                    <td>${order.cliente}</td>
                    <td><strong>${formatCurrency(order.valor_pedido)}</strong></td>
                    <td><strong>${formatCurrency(order.valor_domicilio)}</strong></td>
                    <td><strong>${formatCurrency(order.valor_pedido + order.valor_domicilio)}</strong></td>
                    <td>${order.domiciliario_nombre || 'Sin asignar'}</td>
                    <td>${order.numero_datafono || '--'}</td>
                    <td>${order.metodo_pago === 'efectivo' ? 'Efectivo' : order.metodo_pago === 'tarjeta' ? 'Tarjeta' : '--'}</td>
                    <td></td>
                    <td>${order.tiempo_aceptacion ? calculateElapsedTime(order.tiempo_aceptacion) : '--'}</td>
                `;
                
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge status-' + order.estado;
                statusBadge.textContent = order.estado.charAt(0).toUpperCase() + order.estado.slice(1);
                row.cells[9].appendChild(statusBadge);
            });
        }
        
        // Event listeners para filtros del dashboard
        document.getElementById('btn-apply-filters').addEventListener('click', () => {
            loadDashboard();
        });
        
        document.getElementById('btn-clear-filters').addEventListener('click', () => {
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-delivery-type').value = '';
            document.getElementById('filter-delivery-person').value = '';
            document.getElementById('filter-dataphone').value = '';
            document.getElementById('filter-payment-method').value = '';
            document.getElementById('filter-voucher-status').value = '';
            document.getElementById('filter-order-status').value = '';
            loadDashboard();
        });

        // ============================================
        // M√ìDULO DE CONSULTA DE PEDIDOS
        // ============================================

        /**
         * Cargar filtros de b√∫squeda (domiciliarios disponibles)
         */
        async function loadSearchFilters() {
            if (!supabase) return;
            try {
                // Cargar todos los domiciliarios (sin filtro de configuraci√≥n diaria)
                const { data: drivers, error } = await supabase
                    .from('domiciliarios')
                    .select('*')
                    .order('nombre');

                if (error) throw error;

                const select = document.getElementById('search-domiciliario');
                select.innerHTML = '<option value="">Todos</option>';

                drivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.id;
                    option.textContent = driver.nombre;
                    select.appendChild(option);
                });

                console.log('‚úÖ Filtros de b√∫squeda cargados');
            } catch (error) {
                console.error('‚ùå Error al cargar filtros:', error);
            }
        }

        /**
         * Buscar pedidos con criterios m√∫ltiples
         */
        async function searchOrders() {
            if (!supabase) return;

            try {
                // Verificar que todos los elementos existen
                const requiredFields = [
                    'search-id', 'search-cliente', 'search-direccion', 'search-barrio',
                    'search-tipo-dom', 'search-domiciliario', 'search-metodo-pago',
                    'search-datafono', 'search-estado-voucher', 'search-estado',
                    'search-fecha-desde', 'search-fecha-hasta'
                ];

                const missingFields = requiredFields.filter(id => !document.getElementById(id));
                if (missingFields.length > 0) {
                    console.error('Campos faltantes en el formulario:', missingFields);
                    showAlert('search-alert', 'error', `Error: Faltan campos en el formulario (${missingFields.join(', ')}). Recarga la p√°gina.`);
                    return;
                }

                // Obtener valores de b√∫squeda con validaci√≥n
                const searchId = document.getElementById('search-id')?.value?.trim()?.toLowerCase() || '';
                const searchCliente = document.getElementById('search-cliente')?.value?.trim()?.toLowerCase() || '';
                const searchDireccion = document.getElementById('search-direccion')?.value?.trim()?.toLowerCase() || '';
                const searchBarrio = document.getElementById('search-barrio')?.value?.trim()?.toLowerCase() || '';
                const searchTipoDom = document.getElementById('search-tipo-dom')?.value || '';
                const searchDomiciliario = document.getElementById('search-domiciliario')?.value || '';
                const searchMetodoPago = document.getElementById('search-metodo-pago')?.value || '';
                const searchDatafono = document.getElementById('search-datafono')?.value?.trim() || '';
                const searchEstadoVoucher = document.getElementById('search-estado-voucher')?.value || '';
                const searchEstado = document.getElementById('search-estado')?.value || '';
                const searchFechaDesde = document.getElementById('search-fecha-desde')?.value || '';
                const searchFechaHasta = document.getElementById('search-fecha-hasta')?.value || '';

                // Obtener todos los pedidos
                const { data: allOrders, error } = await supabase
                    .from('pedidos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Aplicar filtros
                let filteredOrders = allOrders;

                if (searchId) {
                    filteredOrders = filteredOrders.filter(o =>
                        o.id.toLowerCase().includes(searchId)
                    );
                }

                if (searchCliente) {
                    filteredOrders = filteredOrders.filter(o =>
                        o.cliente.toLowerCase().includes(searchCliente)
                    );
                }

                if (searchDireccion) {
                    filteredOrders = filteredOrders.filter(o =>
                        o.direccion.toLowerCase().includes(searchDireccion)
                    );
                }

                if (searchBarrio) {
                    filteredOrders = filteredOrders.filter(o =>
                        o.barrio && o.barrio.toLowerCase().includes(searchBarrio)
                    );
                }

                if (searchTipoDom) {
                    filteredOrders = filteredOrders.filter(o =>
                        o.tipo_domiciliario === searchTipoDom
                    );
                }

                if (searchDomiciliario) {
                    filteredOrders = filteredOrders.filter(o =>
                        o.domiciliario_id === searchDomiciliario
                    );
                }

                if (searchMetodoPago) {
                    filteredOrders = filteredOrders.filter(o =>
                        o.metodo_pago === searchMetodoPago
                    );
                }

                if (searchDatafono) {
                    filteredOrders = filteredOrders.filter(o =>
                        o.numero_datafono && o.numero_datafono.toString().includes(searchDatafono)
                    );
                }

                if (searchEstadoVoucher) {
                    filteredOrders = filteredOrders.filter(o =>
                        o.estado_voucher === searchEstadoVoucher
                    );
                }

                if (searchEstado) {
                    filteredOrders = filteredOrders.filter(o =>
                        o.estado === searchEstado
                    );
                }

                if (searchFechaDesde) {
                    try {
                        const fechaDesde = new Date(searchFechaDesde + 'T00:00:00');
                        filteredOrders = filteredOrders.filter(o => {
                            const orderDate = new Date(o.created_at);
                            return orderDate >= fechaDesde;
                        });
                    } catch (e) {
                        console.error('Error al procesar fecha desde:', e);
                    }
                }

                if (searchFechaHasta) {
                    try {
                        const fechaHasta = new Date(searchFechaHasta + 'T23:59:59');
                        filteredOrders = filteredOrders.filter(o => {
                            const orderDate = new Date(o.created_at);
                            return orderDate <= fechaHasta;
                        });
                    } catch (e) {
                        console.error('Error al procesar fecha hasta:', e);
                    }
                }

                // Renderizar resultados
                renderSearchResults(filteredOrders);

                // Mostrar mensaje de resultados
                if (filteredOrders.length === 0) {
                    showAlert('search-alert', 'warning', 'No se encontraron pedidos con los criterios especificados');
                } else {
                    showAlert('search-alert', 'success', `Se encontraron ${filteredOrders.length} pedido(s)`);
                }

            } catch (error) {
                console.error('‚ùå Error al buscar pedidos:', error);
                showAlert('search-alert', 'error', 'Error al realizar la b√∫squeda: ' + (error.message || 'Error desconocido'));
            }
        }

        /**
         * Renderizar resultados de b√∫squeda
         */
        function renderSearchResults(orders) {
            const tbody = document.getElementById('search-results-table');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 30px;">No se encontraron pedidos</td></tr>';
                return;
            }

            orders.forEach(order => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td style="text-align: center;"><strong>#${order.id.substring(0, 8)}</strong></td>
                    <td style="text-align: center;"><strong>${order.cliente}</strong><br><small style="font-size: 11px;">${order.telefono_cliente}</small></td>
                    <td style="text-align: center; font-size: 12px;">${order.direccion}</td>
                    <td style="text-align: center; font-size: 12px;">${order.barrio || '--'}</td>
                    <td style="text-align: center;"><strong>${formatCurrency(order.valor_pedido + order.valor_domicilio)}</strong></td>
                    <td style="text-align: center;">${order.tipo_domiciliario ? (order.tipo_domiciliario === 'propio' ? 'Propio' : 'Rappi') : '--'}</td>
                    <td style="text-align: center;">${order.domiciliario_nombre || '--'}</td>
                    <td style="text-align: center;">${order.metodo_pago === 'efectivo' ? 'Efectivo' : order.metodo_pago === 'tarjeta' ? 'Tarjeta' : '--'}</td>
                    <td style="text-align: center;">${order.numero_datafono || '--'}</td>
                    <td style="text-align: center;"></td>
                    <td style="text-align: center;"></td>
                    <td style="text-align: center;">${order.tiempo_aceptacion ? calculateElapsedTime(order.tiempo_aceptacion) : '--'}</td>
                `;

                // Estado Voucher
                const voucherBadge = document.createElement('span');
                voucherBadge.className = 'badge ' + (order.estado_voucher === 'entregado' ? 'badge-success' : 'badge-warning');
                voucherBadge.textContent = order.estado_voucher === 'entregado' ? 'Entregado' : 'Pendiente';
                row.cells[9].appendChild(voucherBadge);

                // Estado
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge status-' + order.estado;
                statusBadge.textContent = order.estado.charAt(0).toUpperCase() + order.estado.slice(1);
                row.cells[10].appendChild(statusBadge);
            });
        }

        /**
         * Limpiar filtros de b√∫squeda
         */
        function clearSearchFilters() {
            // Limpiar campos con validaci√≥n
            const fields = [
                'search-id', 'search-cliente', 'search-direccion', 'search-barrio',
                'search-tipo-dom', 'search-domiciliario', 'search-metodo-pago',
                'search-datafono', 'search-estado-voucher', 'search-estado',
                'search-fecha-desde', 'search-fecha-hasta'
            ];

            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = '';
                }
            });

            // Limpiar resultados
            const tbody = document.getElementById('search-results-table');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 30px;">Utiliza los filtros de b√∫squeda para encontrar pedidos</td></tr>';
            }

            // Limpiar alerta
            const alert = document.getElementById('search-alert');
            if (alert) {
                alert.innerHTML = '';
            }
        }

        // Event listeners para Consulta de Pedidos
        document.getElementById('btn-search-orders').addEventListener('click', searchOrders);
        document.getElementById('btn-clear-search').addEventListener('click', clearSearchFilters);

        // ============================================
        // CONFIGURACI√ìN GENERAL
        // ============================================

        /**
         * Cargar configuraci√≥n general
         */
        async function loadGeneralConfig() {
            if (!supabase) return;
            try {
                const { data, error } = await supabase
                    .from('configuracion_general')
                    .select('*')
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                    throw error;
                }

                if (data && data.hora_reinicio) {
                    document.getElementById('config-reset-time').value = data.hora_reinicio;
                    console.log('‚úÖ Configuraci√≥n cargada:', data.hora_reinicio);
                } else {
                    // Si no hay configuraci√≥n, crear con valores por defecto
                    await createDefaultConfig();
                }
            } catch (error) {
                console.error('‚ùå Error al cargar configuraci√≥n:', error);
            }
        }

        /**
         * Crear configuraci√≥n por defecto
         */
        async function createDefaultConfig() {
            if (!supabase) return;
            try {
                const { error } = await supabase
                    .from('configuracion_general')
                    .insert({
                        hora_reinicio: '08:00',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;
                console.log('‚úÖ Configuraci√≥n por defecto creada');
            } catch (error) {
                console.error('‚ùå Error al crear configuraci√≥n por defecto:', error);
            }
        }

        /**
         * Guardar hora de reinicio
         */
        async function saveResetTime() {
            if (!supabase) return;
            try {
                const resetTime = document.getElementById('config-reset-time').value;

                if (!resetTime) {
                    showAlert('config-alert', 'error', 'Debe ingresar una hora de reinicio');
                    return;
                }

                // Verificar si ya existe configuraci√≥n
                const { data: existing } = await supabase
                    .from('configuracion_general')
                    .select('id')
                    .single();

                if (existing) {
                    // Actualizar configuraci√≥n existente
                    const { error } = await supabase
                        .from('configuracion_general')
                        .update({
                            hora_reinicio: resetTime,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existing.id);

                    if (error) throw error;
                } else {
                    // Crear nueva configuraci√≥n
                    const { error } = await supabase
                        .from('configuracion_general')
                        .insert({
                            hora_reinicio: resetTime,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });

                    if (error) throw error;
                }

                showAlert('config-alert', 'success', `Hora de reinicio guardada: ${resetTime} (Hora Colombia)`);
                console.log('‚úÖ Hora de reinicio guardada:', resetTime);

                // Recargar pedidos para aplicar el nuevo filtro
                if (document.querySelector('.menu-item[data-module="pedidos"]').classList.contains('active')) {
                    await loadOrders();
                }
            } catch (error) {
                console.error('‚ùå Error al guardar hora de reinicio:', error);
                showAlert('config-alert', 'error', 'Error al guardar configuraci√≥n: ' + error.message);
            }
        }

        /**
         * Obtener timestamp de reinicio del d√≠a actual en hora Colombia
         */
        async function getTodayResetTimestamp() {
            if (!supabase) return getTodayResetTimestampFromTime('08:00');

            try {
                const { data, error } = await supabase
                    .from('configuracion_general')
                    .select('hora_reinicio')
                    .single();

                if (error) {
                    // Si hay error (ej: tabla no existe), usar 08:00 por defecto
                    console.warn('‚ö†Ô∏è No se pudo obtener hora_reinicio, usando 08:00 por defecto');
                    return getTodayResetTimestampFromTime('08:00');
                }

                if (!data) {
                    // Si no hay configuraci√≥n, usar 08:00 por defecto
                    console.warn('‚ö†Ô∏è No hay configuraci√≥n, usando 08:00 por defecto');
                    return getTodayResetTimestampFromTime('08:00');
                }

                return getTodayResetTimestampFromTime(data.hora_reinicio);
            } catch (error) {
                console.warn('‚ö†Ô∏è Error al obtener timestamp de reinicio, usando 08:00 por defecto:', error);
                return getTodayResetTimestampFromTime('08:00');
            }
        }

        /**
         * Calcular timestamp de reinicio para una hora espec√≠fica
         * Retorna el timestamp del reinicio del D√çA ACTUAL en hora Colombia (siempre 8 AM)
         */
        function getTodayResetTimestampFromTime(timeString) {
            // Extraer hora y minuto de la configuraci√≥n
            const [hours, minutes] = timeString.split(':').map(Number);

            // Obtener la fecha actual en Colombia usando Intl.DateTimeFormat
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/Bogota',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            const parts = formatter.formatToParts(new Date());
            const dateObj = {};
            parts.forEach(({ type, value }) => {
                dateObj[type] = value;
            });

            console.log('üìÖ Fecha actual en Colombia:', dateObj);

            // Construir string de fecha en formato ISO para el reinicio de HOY en Colombia
            const resetColombiaString = `${dateObj.year}-${dateObj.month}-${dateObj.day}T${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:00-05:00`;

            // Convertir a Date - esto maneja autom√°ticamente el offset
            const resetDateUTC = new Date(resetColombiaString);

            console.log(`‚è∞ Hora de reinicio calculada:`, {
                horaConfiguracion: timeString,
                fechaHoraColombia: `${dateObj.year}-${dateObj.month}-${dateObj.day} ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:00`,
                stringConOffset: resetColombiaString,
                reinicioUTC: resetDateUTC.toISOString(),
                timestampUTC: resetDateUTC.getTime()
            });

            return resetDateUTC.toISOString();
        }

        // Event listener para guardar hora de reinicio
        document.getElementById('btn-save-reset-time').addEventListener('click', saveResetTime);

        // ============================================
        // M√ìDULO DE CUADRE DE CAJA
        // ============================================

        /**
         * Cargar domiciliarios para el filtro de cuadre
         */
        async function loadCuadreFilters() {
            if (!supabase) return;
            try {
                const { data: drivers, error } = await supabase
                    .from('domiciliarios')
                    .select('*')
                    .order('nombre');

                if (error) throw error;

                const select = document.getElementById('cuadre-domiciliario');
                select.innerHTML = '<option value="">Todos los Domiciliarios</option>';

                drivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.id;
                    option.textContent = driver.nombre;
                    select.appendChild(option);
                });

                // Establecer fecha de hoy por defecto
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('cuadre-fecha').value = today;

                console.log('‚úÖ Filtros de cuadre cargados');
            } catch (error) {
                console.error('‚ùå Error al cargar filtros de cuadre:', error);
            }
        }

        /**
         * Calcular cuadre de caja
         */
        async function calcularCuadreCaja() {
            if (!supabase) return;

            try {
                const fecha = document.getElementById('cuadre-fecha').value;
                const domiciliarioId = document.getElementById('cuadre-domiciliario').value;

                if (!fecha) {
                    showAlert('cuadre-alert', 'error', 'Debe seleccionar una fecha');
                    return;
                }

                // Obtener configuraci√≥n de domiciliarios del d√≠a
                let configQuery = supabase
                    .from('configuracion_diaria')
                    .select('domiciliario_id, valor_arranque')
                    .eq('fecha', fecha);

                // Filtrar por domiciliario si est√° seleccionado
                if (domiciliarioId) {
                    configQuery = configQuery.eq('domiciliario_id', domiciliarioId);
                }

                const { data: config, error: configError } = await configQuery;

                if (configError) throw configError;

                // Obtener pedidos del d√≠a
                const fechaInicio = new Date(fecha + 'T00:00:00');
                const fechaFin = new Date(fecha + 'T23:59:59');

                let query = supabase
                    .from('pedidos')
                    .select('*')
                    .gte('created_at', fechaInicio.toISOString())
                    .lte('created_at', fechaFin.toISOString())
                    .eq('tipo_domiciliario', 'propio')
                    .in('estado', ['asignado', 'en_camino', 'entregado']);

                if (domiciliarioId) {
                    query = query.eq('domiciliario_id', domiciliarioId);
                }

                const { data: pedidos, error: pedidosError } = await query;

                if (pedidosError) throw pedidosError;

                console.log(`üì¶ Pedidos encontrados para ${fecha}:`, pedidos.length);
                console.log('Pedidos con tarjeta:', pedidos.filter(p => p.metodo_pago === 'tarjeta').length);

                // Obtener informaci√≥n de domiciliarios
                const { data: allDrivers, error: driversError } = await supabase
                    .from('domiciliarios')
                    .select('*');

                if (driversError) throw driversError;

                // Calcular cuadre por domiciliario
                const cuadrePorDomiciliario = {};

                // Inicializar con configuraci√≥n del d√≠a
                if (config) {
                    config.forEach(c => {
                        const driver = allDrivers.find(d => d.id === c.domiciliario_id);
                        if (driver) {
                            cuadrePorDomiciliario[c.domiciliario_id] = {
                                nombre: driver.nombre,
                                valorArranque: c.valor_arranque || 0,
                                efectivo: 0,
                                tarjetas: {},
                                totalTarjetas: 0,
                                total: c.valor_arranque || 0
                            };
                        }
                    });
                }

                // Procesar pedidos
                pedidos.forEach(pedido => {
                    if (!pedido.domiciliario_id) return;

                    // Inicializar si no existe
                    if (!cuadrePorDomiciliario[pedido.domiciliario_id]) {
                        const driver = allDrivers.find(d => d.id === pedido.domiciliario_id);
                        cuadrePorDomiciliario[pedido.domiciliario_id] = {
                            nombre: driver ? driver.nombre : 'Desconocido',
                            valorArranque: 0,
                            efectivo: 0,
                            tarjetas: {},
                            totalTarjetas: 0,
                            total: 0
                        };
                    }

                    const cuadre = cuadrePorDomiciliario[pedido.domiciliario_id];
                    const valorDomicilio = pedido.valor_domicilio || 0;

                    if (pedido.metodo_pago === 'efectivo') {
                        cuadre.efectivo += valorDomicilio;
                    } else if (pedido.metodo_pago === 'tarjeta') {
                        if (pedido.numero_datafono) {
                            const datafono = pedido.numero_datafono;
                            if (!cuadre.tarjetas[datafono]) {
                                cuadre.tarjetas[datafono] = 0;
                            }
                            cuadre.tarjetas[datafono] += valorDomicilio;
                            cuadre.totalTarjetas += valorDomicilio;
                            console.log(`üí≥ Tarjeta procesada - Domiciliario: ${cuadre.nombre}, Datafono: ${datafono}, Valor: ${valorDomicilio}`);
                        } else {
                            console.warn(`‚ö†Ô∏è Pedido con tarjeta sin datafono:`, pedido.id, pedido.cliente);
                        }
                    }

                    cuadre.total = cuadre.valorArranque + cuadre.efectivo + cuadre.totalTarjetas;
                });

                // Renderizar resultados
                renderCuadreCaja(cuadrePorDomiciliario, fecha);

                showAlert('cuadre-alert', 'success', `Cuadre calculado para ${Object.keys(cuadrePorDomiciliario).length} domiciliario(s)`);

            } catch (error) {
                console.error('‚ùå Error al calcular cuadre:', error);
                showAlert('cuadre-alert', 'error', 'Error al calcular cuadre: ' + error.message);
            }
        }

        /**
         * Renderizar cuadre de caja
         */
        function renderCuadreCaja(cuadrePorDomiciliario, fecha) {
            const tbody = document.getElementById('cuadre-table-body');
            tbody.innerHTML = '';

            // Ocultar mensaje inicial
            document.getElementById('cuadre-initial-message').style.display = 'none';

            if (Object.keys(cuadrePorDomiciliario).length === 0) {
                document.getElementById('cuadre-summary').style.display = 'none';
                document.getElementById('cuadre-table-container').style.display = 'none';
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">No hay domiciliarios activos para esta fecha</td></tr>';
                return;
            }

            // Mostrar resumen y tabla
            document.getElementById('cuadre-summary').style.display = 'block';
            document.getElementById('cuadre-table-container').style.display = 'block';

            // Calcular totales generales
            let totalEfectivoCompleto = 0; // arranque + efectivo de pedidos
            let totalTarjetas = 0;

            Object.values(cuadrePorDomiciliario).forEach(cuadre => {
                totalEfectivoCompleto += cuadre.valorArranque + cuadre.efectivo; // Suma arranque + efectivo
                totalTarjetas += cuadre.totalTarjetas;
            });

            const totalGeneral = totalEfectivoCompleto + totalTarjetas;

            // Actualizar resumen
            document.getElementById('cuadre-total-efectivo').textContent = formatCurrency(totalEfectivoCompleto);
            document.getElementById('cuadre-total-tarjetas').textContent = formatCurrency(totalTarjetas);
            document.getElementById('cuadre-total-general').textContent = formatCurrency(totalGeneral);

            // Renderizar tabla
            Object.entries(cuadrePorDomiciliario).forEach(([domiciliarioId, cuadre]) => {
                const row = tbody.insertRow();

                // Nombre del domiciliario
                const cellNombre = row.insertCell();
                cellNombre.style.textAlign = 'center';
                cellNombre.innerHTML = `<strong>${cuadre.nombre}</strong>`;

                // Valor arranque
                const cellArranque = row.insertCell();
                cellArranque.style.textAlign = 'center';
                cellArranque.innerHTML = `<strong>${formatCurrency(cuadre.valorArranque)}</strong>`;

                // Efectivo pedidos
                const cellEfectivoPedidos = row.insertCell();
                cellEfectivoPedidos.style.textAlign = 'center';
                cellEfectivoPedidos.innerHTML = `<span style="color: #27ae60; font-weight: bold;">${formatCurrency(cuadre.efectivo)}</span>`;

                // Total efectivo (arranque + pedidos)
                const totalEfectivoDomiciliario = cuadre.valorArranque + cuadre.efectivo;
                const cellTotalEfectivo = row.insertCell();
                cellTotalEfectivo.style.textAlign = 'center';
                cellTotalEfectivo.style.backgroundColor = '#e8f5e9';
                cellTotalEfectivo.innerHTML = `<strong style="color: #27ae60; font-size: 15px;">${formatCurrency(totalEfectivoDomiciliario)}</strong>`;

                // Tarjetas por datafono
                const cellTarjetas = row.insertCell();
                cellTarjetas.style.textAlign = 'left';
                cellTarjetas.style.padding = '10px';

                if (Object.keys(cuadre.tarjetas).length > 0) {
                    const tarjetasHTML = Object.entries(cuadre.tarjetas)
                        .map(([datafono, valor]) =>
                            `<div style="display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #eee;">
                                <span style="color: #666;">Datafono ${datafono}:</span>
                                <strong style="color: #3498db;">${formatCurrency(valor)}</strong>
                            </div>`
                        )
                        .join('');
                    cellTarjetas.innerHTML = tarjetasHTML;
                } else {
                    cellTarjetas.innerHTML = '<span style="color: #999;">--</span>';
                    cellTarjetas.style.textAlign = 'center';
                }

                // Total
                const cellTotal = row.insertCell();
                cellTotal.style.textAlign = 'center';
                cellTotal.innerHTML = `<strong style="color: #667eea; font-size: 16px;">${formatCurrency(cuadre.total)}</strong>`;
            });
        }

        /**
         * Limpiar cuadre de caja
         */
        function limpiarCuadreCaja() {
            document.getElementById('cuadre-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('cuadre-domiciliario').value = '';

            document.getElementById('cuadre-summary').style.display = 'none';
            document.getElementById('cuadre-table-container').style.display = 'none';
            document.getElementById('cuadre-initial-message').style.display = 'block';

            const tbody = document.getElementById('cuadre-table-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">Selecciona una fecha y haz clic en "Calcular Cuadre"</td></tr>';

            document.getElementById('cuadre-alert').innerHTML = '';
        }

        // Event listeners para Cuadre de Caja
        document.getElementById('btn-calcular-cuadre').addEventListener('click', calcularCuadreCaja);
        document.getElementById('btn-limpiar-cuadre').addEventListener('click', limpiarCuadreCaja);

        loadUsers();
        
        // Restaurar el m√≥dulo activo al recargar la p√°gina
        function restoreActiveModule() {
            const savedModule = localStorage.getItem('fluxi_active_module');
            if (savedModule) {
                // Encontrar el elemento del men√∫ correspondiente
                const menuItem = document.querySelector(`.menu-item[data-module="${savedModule}"]`);
                if (menuItem) {
                    // Simular clic en el elemento del men√∫
                    menuItem.click();
                    console.log(`‚úÖ M√≥dulo "${savedModule}" restaurado`);
                } else {
                    // Si no se encuentra el m√≥dulo guardado, cargar el dashboard por defecto
                    document.querySelector('.menu-item[data-module="dashboard"]').click();
                }
            } else {
                // Si no hay m√≥dulo guardado, cargar el dashboard por defecto
                document.querySelector('.menu-item[data-module="dashboard"]').click();
            }
        }
        
        // Ejecutar restauraci√≥n despu√©s de que todo est√© cargado
        setTimeout(restoreActiveModule, 100);
    </script>
</body>
</html>